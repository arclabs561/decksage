---
name: MegaLinter

on:
  # Run on all PRs and pushes to main
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

  # Allow manual trigger
  workflow_dispatch:

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  megalinter:
    name: MegaLinter
    runs-on: ubuntu-latest

    # Grant write permissions for PR comments and commits
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: MegaLinter
        id: ml
        uses: oxsecurity/megalinter/flavors/cupcake@v9
        env:
          # Configuration
          VALIDATE_ALL_CODEBASE: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Apply fixes on main branch only, not on PRs
          APPLY_FIXES: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'all' || 'none' }}

          # Reporting
          GITHUB_COMMENT_REPORTER: true
          GITHUB_STATUS_REPORTER: true
          SARIF_REPORTER: true

          # Performance
          PARALLEL: true
          LOG_LEVEL: INFO

      # Upload MegaLinter artifacts
      - name: Archive MegaLinter Reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: megalinter-reports
          path: |
            megalinter-reports
            mega-linter.log

      # Upload SARIF for GitHub Security tab
      - name: Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: megalinter-reports/megalinter.sarif
          category: megalinter

      # Create commit with fixes (main branch only)
      - name: Commit and push applied fixes
        if: >
          steps.ml.outputs.has_updated_sources == 1 &&
          github.event_name == 'push' &&
          github.ref == 'refs/heads/main'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: apply MegaLinter fixes"
          commit_user_name: megalinter-bot
          commit_user_email: bot@megalinter.io
        permissions:
          contents: write
