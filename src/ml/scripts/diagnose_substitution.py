#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [ # "gensim>=4.3.0", # "pandas>=2.0.0", # ] # /// """ Diagnose why card substitution is failing. Checks: 1. Are test pairs in vocabulary? 2. Do embeddings capture the relationships? 3. What's the similarity score? """ from __future__ import annotations import argparse import json from pathlib import Path from typing import Any try: import pandas as pd from gensim.models import KeyedVectors HAS_DEPS = True except ImportError: HAS_DEPS = False # Fix import path import sys script_dir = Path(__file__).parent src_dir = script_dir.parent.parent if str(src_dir) not in sys.path: sys.path.insert(0, str(src_dir)) try: from ml.similarity.fusion import WeightedLateFusion, FusionWeights from ml.utils.name_normalizer import NameMapper HAS_FUSION = True except ImportError: HAS_FUSION = False def load_jaccard_graph(pairs_csv: Path | None = None, graph_db: Path | None = None, game: str | None = None) -> dict[str, set[str]]: """Load Jaccard graph (uses shared implementation).""" from ml.utils.shared_operations import load_jaccard_graph as shared_load return shared_load(pairs_csv=pairs_csv, graph_db=graph_db, game=game, max_rows=100000) def main() -> int: """Diagnose substitution issues.""" parser = argparse.ArgumentParser(description="Diagnose card substitution") parser.add_argument("--embedding", type=str, required=True, help="Embedding file") parser.add_argument("--pairs-csv", type=str, required=True, help="Pairs CSV for Jaccard") parser.add_argument("--test-pairs", type=str, required=True, help="Test substitution pairs JSON") parser.add_argument("--name-mapping", type=str, help="Name mapping JSON (optional)") args = parser.parse_args() if not HAS_DEPS: print("Error: Missing dependencies") return 1 # Load embedding print(f"Loading embedding: {args.embedding}") embedding = KeyedVectors.load(args.embedding) vocab = set(embedding.key_to_index.keys()) print(f" Vocabulary: {len(vocab)} cards") # Load name mapper name_mapper = None if args.name_mapping and Path(args.name_mapping).exists(): name_mapper = NameMapper.load_from_file(Path(args.name_mapping)) print(f" Name mappings: {len(name_mapper.mapping)}") # Load test pairs with open(args.test_pairs) as f: test_pairs = json.load(f) print(f"\nTest pairs: {len(test_pairs)}") # Load Jaccard graph print(f"\nLoading Jaccard graph: {args.pairs_csv}") adj = load_jaccard_graph(Path(args.pairs_csv)) print(f" Cards in graph: {len(adj)}") # Create fusion if HAS_FUSION: weights = FusionWeights(embed=0.4, jaccard=0.6) fusion = WeightedLateFusion( embeddings=embedding, adj=adj, weights=weights, ) # Analyze each pair print("\n" + "=" * 70) print("PAIR ANALYSIS") print("=" * 70) stats = { "in_vocab_both": 0, "in_vocab_original": 0, "in_vocab_target": 0, "neither": 0, "embedding_top10": 0, "embedding_top20": 0, "embedding_top50": 0, "jaccard_connected": 0, "fusion_top10": 0, "fusion_top20": 0, "fusion_top50": 0, } for i, (original, target) in enumerate(test_pairs[:20], 1): # Analyze first 20 print(f"\n[{i}] '{original}' â†’ '{target}'") # Map names orig_mapped = name_mapper.map_name(original) if name_mapper else original targ_mapped = name_mapper.map_name(target) if name_mapper else target # Check vocabulary orig_in = orig_mapped in vocab targ_in = targ_mapped in vocab if orig_in and targ_in: stats["in_vocab_both"] += 1 print(" Both in vocabulary") elif orig_in: stats["in_vocab_original"] += 1 print(f" Warning: Original in vocab, target '{targ_mapped}' not") continue elif targ_in: stats["in_vocab_target"] += 1 print(f" Warning: Target in vocab, original '{orig_mapped}' not") continue else: stats["neither"] += 1 print(f" Error: Neither in vocabulary") continue # Check embedding similarity try: similar = embedding.most_similar(orig_mapped, topn=50) similar_cards = [card for card, _ in similar] scores = {card: score for card, score in similar} if targ_mapped in similar_cards[:10]: rank = similar_cards.index(targ_mapped) + 1 score = scores[targ_mapped] stats["embedding_top10"] += 1 print(f" Embedding: rank {rank}, score {score:.4f}") elif targ_mapped in similar_cards[:20]: rank = similar_cards.index(targ_mapped) + 1 score = scores[targ_mapped] stats["embedding_top20"] += 1 print(f" Warning: Embedding: rank {rank}, score {score:.4f} (outside top-10)") elif targ_mapped in similar_cards: rank = similar_cards.index(targ_mapped) + 1 score = scores[targ_mapped] stats["embedding_top50"] += 1 print(f" Warning: Embedding: rank {rank}, score {score:.4f} (outside top-20)") else: print(f" Error: Embedding: not in top-50") if similar_cards: print(f" Top-5: {', '.join(similar_cards[:5])}") except KeyError: print(f" Error: Embedding: original not found") # Check Jaccard connection if orig_mapped in adj and targ_mapped in adj[orig_mapped]: stats["jaccard_connected"] += 1 print(f" Jaccard: directly connected") else: print(f" Error: Jaccard: not directly connected") # Check fusion if HAS_FUSION: try: fusion_results = fusion.similar(orig_mapped, k=50) fusion_cards = [card for card, _ in fusion_results] if targ_mapped in fusion_cards[:10]: rank = fusion_cards.index(targ_mapped) + 1 stats["fusion_top10"] += 1 print(f" Fusion: rank {rank}") elif targ_mapped in fusion_cards[:20]: rank = fusion_cards.index(targ_mapped) + 1 stats["fusion_top20"] += 1 print(f" Warning: Fusion: rank {rank} (outside top-10)") elif targ_mapped in fusion_cards: rank = fusion_cards.index(targ_mapped) + 1 stats["fusion_top50"] += 1 print(f" Warning: Fusion: rank {rank} (outside top-20)") else: print(f" Error: Fusion: not in top-50") except Exception as e: print(f" Warning: Fusion: error - {e}") # Summary print("\n" + "=" * 70) print("SUMMARY (first 20 pairs)") print("=" * 70) print(f"Vocabulary coverage:") print(f" Both in vocab: {stats['in_vocab_both']}/20") print(f" Only original: {stats['in_vocab_original']}/20") print(f" Only target: {stats['in_vocab_target']}/20") print(f" Neither: {stats['neither']}/20") print() print(f"Embedding similarity:") print(f" Top-10: {stats['embedding_top10']}/20") print(f" Top-20: {stats['embedding_top20']}/20") print(f" Top-50: {stats['embedding_top50']}/20") print() print(f"Jaccard connection: {stats['jaccard_connected']}/20") print() if HAS_FUSION: print(f"Fusion:") print(f" Top-10: {stats['fusion_top10']}/20") print(f" Top-20: {stats['fusion_top20']}/20") print(f" Top-50: {stats['fusion_top50']}/20") return 0 if __name__ == "__main__": import sys sys.exit(main())
