#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [ # "pyyaml>=6.0", # ] # /// """ Validate annotation metadata completeness. Checks: 1. LLM annotations have model_name, model_params, timestamp 2. Hand annotations have annotator_id (if IAA needed) 3. Annotation metadata is properly formatted 4. Graph edges have annotation metadata when applicable """ from __future__ import annotations import argparse import json from pathlib import Path from typing import Any try: import yaml HAS_YAML = True except ImportError: HAS_YAML = False import sys script_dir = Path(__file__).parent src_dir = script_dir.parent.parent if str(src_dir) not in sys.path: sys.path.insert(0, str(src_dir)) from ml.utils.annotation_utils import load_similarity_annotations, load_hand_annotations def validate_llm_annotations(annotation_path: Path) -> dict[str, Any]: """Validate LLM annotation metadata.""" annotations = load_similarity_annotations(annotation_path) results = { "total": len(annotations), "with_model_name": 0, "with_model_params": 0, "with_annotator_id": 0, "with_timestamp": 0, "complete_metadata": 0, "issues": [], } required_fields = ["model_name", "model_params", "annotator_id", "timestamp"] for ann in annotations: has_all = True for field in required_fields: if ann.get(field): results[f"with_{field}"] += 1 else: has_all = False if has_all: results["complete_metadata"] += 1 # Calculate percentages if results["total"] > 0: for field in required_fields: key = f"with_{field}" results[f"pct_{field}"] = results[key] / results["total"] * 100 results["pct_complete"] = results["complete_metadata"] / results["total"] * 100 return results def validate_hand_annotations(annotation_path: Path) -> dict[str, Any]: """Validate hand annotation IAA tracking.""" if not HAS_YAML: return {"error": "PyYAML not available"} with open(annotation_path) as f: data = yaml.safe_load(f) tasks = data.get("tasks", []) results = { "total_tasks": len(tasks), "total_candidates": 0, "with_annotator_id": 0, "with_annotation_date": 0, "with_confidence": 0, "graded": 0, "issues": [], } for task in tasks: candidates = task.get("candidates", []) results["total_candidates"] += len(candidates) for cand in candidates: if cand.get("relevance") is not None: results["graded"] += 1 if cand.get("annotator_id"): results["with_annotator_id"] += 1 if cand.get("annotation_date"): results["with_annotation_date"] += 1 if cand.get("confidence"): results["with_confidence"] += 1 # Calculate percentages if results["total_candidates"] > 0: results["pct_annotator_id"] = results["with_annotator_id"] / results["total_candidates"] * 100 results["pct_graded"] = results["graded"] / results["total_candidates"] * 100 return results def main() -> int: parser = argparse.ArgumentParser(description="Validate annotation metadata") parser.add_argument("--input", type=str, required=True, help="Annotation file (YAML or JSONL)") parser.add_argument("--type", type=str, choices=["auto", "llm", "hand"], default="auto", help="Annotation type") args = parser.parse_args() annotation_path = Path(args.input) if not annotation_path.exists(): print(f"Error: Annotation file not found: {annotation_path}") return 1 # Auto-detect type if args.type == "auto": if annotation_path.suffix == ".yaml": ann_type = "hand" else: ann_type = "llm" else: ann_type = args.type print("=" * 70) print(f"VALIDATING {ann_type.upper()} ANNOTATION METADATA") print("=" * 70) print() if ann_type == "llm": results = validate_llm_annotations(annotation_path) print(f" LLM Annotation Metadata:") print(f" Total annotations: {results['total']}") print(f" With model_name: {results['with_model_name']} ({results.get('pct_model_name', 0):.1f}%)") print(f" With model_params: {results['with_model_params']} ({results.get('pct_model_params', 0):.1f}%)") print(f" With annotator_id: {results['with_annotator_id']} ({results.get('pct_annotator_id', 0):.1f}%)") print(f" With timestamp: {results['with_timestamp']} ({results.get('pct_timestamp', 0):.1f}%)") print(f" Complete metadata: {results['complete_metadata']} ({results.get('pct_complete', 0):.1f}%)") else: # hand results = validate_hand_annotations(annotation_path) if "error" in results: print(f"Error: Error: {results['error']}") return 1 print(f" Hand Annotation IAA Tracking:") print(f" Total tasks: {results['total_tasks']}") print(f" Total candidates: {results['total_candidates']}") print(f" Graded: {results['graded']} ({results.get('pct_graded', 0):.1f}%)") print(f" With annotator_id: {results['with_annotator_id']} ({results.get('pct_annotator_id', 0):.1f}%)") print(f" With annotation_date: {results['with_annotation_date']}") print(f" With confidence: {results['with_confidence']}") print() print("=" * 70) print(" Validation complete!") print("=" * 70) return 0 if __name__ == "__main__": import sys sys.exit(main())
