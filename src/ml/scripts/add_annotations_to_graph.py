#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [ # "pyyaml>=6.0", # ] # /// """ Add annotation metadata to graph edges. Updates incremental graph with annotation metadata (similarity_type, role_match, etc.) for edges that correspond to annotated pairs. """ from __future__ import annotations import argparse import json from pathlib import Path from typing import Any try: import yaml HAS_YAML = True except ImportError: HAS_YAML = False import sys script_dir = Path(__file__).parent src_dir = script_dir.parent.parent if str(src_dir) not in sys.path: sys.path.insert(0, str(src_dir)) from ml.utils.annotation_utils import load_similarity_annotations, load_hand_annotations from ml.data.incremental_graph import IncrementalCardGraph def add_annotation_metadata_to_graph( graph_path: Path, annotation_path: Path, output_path: Path | None = None, ) -> dict[str, Any]: """Add annotation metadata to graph edges.""" # Load graph graph = IncrementalCardGraph(graph_path=graph_path) # Load annotations if annotation_path.suffix == ".yaml": annotations = load_hand_annotations(annotation_path) else: annotations = load_similarity_annotations(annotation_path) # Track updates edges_updated = 0 edges_with_metadata = 0 # Update edges with annotation metadata for ann in annotations: card1 = ann.get("card1") card2 = ann.get("card2") if not card1 or not card2: continue edge_key = tuple(sorted([card1, card2])) if edge_key in graph.edges: edge = graph.edges[edge_key] # Add annotation metadata if edge.metadata is None: edge.metadata = {} # Store annotation fields edge.metadata["annotation"] = { "similarity_type": ann.get("similarity_type"), "similarity_score": ann.get("similarity_score"), "is_substitute": ann.get("is_substitute"), "role_match": ann.get("role_match"), "archetype_context": ann.get("archetype_context"), "format_context": ann.get("format_context"), "substitution_quality": ann.get("substitution_quality"), "model_name": ann.get("model_name"), "annotator_id": ann.get("annotator_id"), } edges_updated += 1 if edge.metadata.get("annotation"): edges_with_metadata += 1 # Save updated graph output_file = output_path or graph_path graph.save(output_file) return { "edges_updated": edges_updated, "edges_with_metadata": edges_with_metadata, "total_annotations": len(annotations), } def main() -> int: parser = argparse.ArgumentParser(description="Add annotation metadata to graph") parser.add_argument("--graph", type=str, required=True, help="Graph JSON file") parser.add_argument("--annotations", type=str, required=True, help="Annotation file (YAML or JSONL)") parser.add_argument("--output", type=str, help="Output graph file (default: overwrite input)") args = parser.parse_args() graph_path = Path(args.graph) annotation_path = Path(args.annotations) output_path = Path(args.output) if args.output else None if not graph_path.exists(): print(f"Error: Graph file not found: {graph_path}") return 1 if not annotation_path.exists(): print(f"Error: Annotation file not found: {annotation_path}") return 1 print(f"Loading graph: {graph_path}") print(f"Loading annotations: {annotation_path}") results = add_annotation_metadata_to_graph(graph_path, annotation_path, output_path) print(f"\n Updated {results['edges_updated']} edges with annotation metadata") print(f" {results['edges_with_metadata']} edges now have annotation metadata") print(f" Processed {results['total_annotations']} annotations") if output_path: print(f"\nðŸ’¾ Saved updated graph to: {output_path}") return 0 if __name__ == "__main__": import sys sys.exit(main())