#!/usr/bin/env python3 """ Quick test of multitask training implementation. Creates a small synthetic dataset and verifies the training pipeline works. """ import json import tempfile from pathlib import Path try: import pandas as pd from gensim.models import KeyedVectors from ml.scripts.train_multitask_refined import train_multitask_embeddings HAS_DEPS = True except ImportError as e: print(f"Missing dependencies: {e}") HAS_DEPS = False def create_test_data(): """Create small synthetic test dataset.""" # Create test pairs CSV pairs_data = { "NAME_1": ["Lightning Bolt", "Lightning Bolt", "Chain Lightning", "Brainstorm", "Ponder"], "NAME_2": ["Chain Lightning", "Shock", "Shock", "Ponder", "Preordain"], "COUNT_MULTISET": [10, 5, 8, 15, 12], } pairs_df = pd.DataFrame(pairs_data) # Create test substitution pairs substitution_pairs = [ ["Lightning Bolt", "Chain Lightning"], ["Brainstorm", "Ponder"], ] return pairs_df, substitution_pairs def test_multitask_training(): """Test multitask training with synthetic data.""" if not HAS_DEPS: print("Error: Missing dependencies") return False print("ðŸ§ª Testing multitask training...") # Create test data pairs_df, substitution_pairs = create_test_data() # Write to temp files with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False) as f: pairs_path = Path(f.name) pairs_df.to_csv(f.name, index=False) with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as f: sub_path = Path(f.name) json.dump(substitution_pairs, f) with tempfile.NamedTemporaryFile(mode='w', suffix='.wv', delete=False) as f: output_path = Path(f.name) try: # Train (using refined version - output_path is required and comes first) wv = train_multitask_embeddings( pairs_csv=pairs_path, output_path=output_path, substitution_pairs_path=sub_path, dim=32, # Small for testing walk_length=10, num_walks=2, window_size=5, epochs=2, cooccurrence_weight=1.0, substitution_weight=5.0, min_cooccurrence=1, # Allow all pairs for small test workers=1, ) # Verify output assert isinstance(wv, KeyedVectors), "Should return KeyedVectors" assert len(wv) > 0, "Should have embeddings" assert wv.vector_size == 32, "Should have correct dimension" # Test similarity if "Lightning Bolt" in wv and "Chain Lightning" in wv: sim = wv.similarity("Lightning Bolt", "Chain Lightning") print(f" Lightning Bolt â†” Chain Lightning similarity: {sim:.3f}") print(" Multitask training test passed") return True except Exception as e: print(f"Error: Test failed: {e}") import traceback traceback.print_exc() return False finally: # Cleanup for p in [pairs_path, sub_path, output_path]: if p.exists(): p.unlink() if __name__ == "__main__": import sys success = test_multitask_training() sys.exit(0 if success else 1)
