#!/bin/bash # Full LLM labeling pipeline # Expands test set and improves label quality set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)" cd "$PROJECT_ROOT" NUM_QUERIES="${1:-50}" TARGET_SIZE=100 echo " Starting LLM Labeling Pipeline" echo " Target: Expand to ${TARGET_SIZE}+ queries with 10+ labels each" echo " Adding: ${NUM_QUERIES} new queries" echo "" # Step 1: Expand test set echo "Step 1/4: Expanding test set with ${NUM_QUERIES} new queries..." uv run --script src/ml/scripts/expand_test_set_with_llm.py \ --input experiments/test_set_unified_magic.json \ --output experiments/test_set_expanded_magic.json \ --num-queries "${NUM_QUERIES}" \ --num-judges 3 \ --batch-size 10 if [ ! -f "experiments/test_set_expanded_magic.json" ]; then echo "Error: Expansion failed" exit 1 fi echo " Expansion complete" echo "" # Step 2: Re-label queries with insufficient labels echo "Step 2/4: Re-labeling queries with <10 labels..." uv run --script src/ml/scripts/batch_label_existing_queries.py \ --input experiments/test_set_expanded_magic.json \ --output experiments/test_set_relabeled_magic.json \ --num-judges 3 \ --min-labels 10 \ --replace-fallback \ --batch-size 10 if [ ! -f "experiments/test_set_relabeled_magic.json" ]; then echo "Warning: Re-labeling failed, using expanded set" cp experiments/test_set_expanded_magic.json experiments/test_set_relabeled_magic.json fi echo " Re-labeling complete" echo "" # Step 3: Compute IAA echo "Step 3/4: Computing IAA analysis..." uv run --script src/ml/scripts/compute_iaa_for_test_set.py \ --test-set experiments/test_set_relabeled_magic.json \ --output experiments/iaa_analysis.json echo " IAA analysis complete" echo "" # Step 4: Summary echo "Step 4/4: Generating summary..." python3 << 'PYEOF' import json from pathlib import Path test_set = Path("experiments/test_set_relabeled_magic.json") if test_set.exists(): with open(test_set) as f: data = json.load(f) queries = data.get("queries", data) if isinstance(data, dict) else data total_queries = len(queries) queries_with_iaa = sum(1 for q, d in queries.items() if isinstance(d, dict) and d.get("iaa")) total_labels = 0 queries_with_sufficient = 0 for q, d in queries.items(): if isinstance(d, dict): labels = sum(len(d.get(level, [])) for level in ["highly_relevant", "relevant", "somewhat_relevant", "marginally_relevant"]) total_labels += labels if labels >= 10: queries_with_sufficient += 1 print("=" * 60) print("Final Test Set Summary") print("=" * 60) print(f"Total queries: {total_queries}") print(f"Queries with IAA data: {queries_with_iaa}") print(f"Queries with 10+ labels: {queries_with_sufficient}/{total_queries}") print(f"Average labels per query: {total_labels/total_queries if total_queries > 0 else 0:.1f}") print(f"Total labels: {total_labels}") print() if total_queries >= 100 and queries_with_sufficient >= 80: print(" Target achieved!") else: print(f"Warning: Target: 100+ queries, 80+ with 10+ labels") print(f" Need: {max(0, 100 - total_queries)} more queries") PYEOF echo "" echo " Pipeline complete!" echo "" echo "üìÅ Output files:" echo " - experiments/test_set_expanded_magic.json" echo " - experiments/test_set_relabeled_magic.json" echo " - experiments/iaa_analysis.json"
