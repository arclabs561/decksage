#!/usr/bin/env python3 """ Update Incremental Graph with Enhanced Similarity Edges Adds text and functional similarity edges to the incremental graph, ensuring all new data is incorporated into graph construction. """ from pathlib import Path import json import pandas as pd from collections import defaultdict def update_incremental_graph_with_enhanced_edges( graph_path: Path, pairs_csv: Path, output_path: Path | None = None ) -> dict: """ Update incremental graph with enhanced similarity edges. Args: graph_path: Path to existing incremental graph JSON pairs_csv: Path to enhanced pairs CSV with TEXT_SIMILARITY and FUNCTIONAL_SIMILARITY output_path: Optional output path (defaults to graph_path) Returns: Updated graph dictionary """ # Load existing graph or create new if graph_path.exists(): with open(graph_path) as f: graph = json.load(f) else: graph = { "nodes": {}, "edges": [], "metadata": { "version": "1.0", "last_updated": None, "edge_types": ["co_occurrence", "text_similarity", "functional_similarity"] } } # Load enhanced pairs print(f"Loading enhanced pairs from {pairs_csv}...") df = pd.read_csv(pairs_csv) print(f" Loaded {len(df):,} pairs") # Track new edges new_text_edges = 0 new_func_edges = 0 updated_edges = 0 # Create edge set for quick lookup existing_edges = set() if "edges" in graph: for edge in graph["edges"]: # Handle both dict and Edge object formats if isinstance(edge, dict): source = edge.get("source") or edge.get("card1") target = edge.get("target") or edge.get("card2") else: # Edge object from IncrementalCardGraph source = edge.card1 if hasattr(edge, "card1") else None target = edge.card2 if hasattr(edge, "card2") else None if source and target: key = tuple(sorted([source, target])) existing_edges.add(key) # Process pairs for _, row in df.iterrows(): card1 = row.get("NAME_1", "") card2 = row.get("NAME_2", "") if not card1 or not card2: continue edge_key = tuple(sorted([card1, card2])) # Check for text similarity text_sim = row.get("TEXT_SIMILARITY") if pd.notna(text_sim) and text_sim > 0: if edge_key not in existing_edges: graph["edges"].append({ "source": card1, "target": card2, "weight": float(text_sim), "type": "text_similarity", "metadata": {"similarity": float(text_sim)} }) existing_edges.add(edge_key) new_text_edges += 1 else: # Update existing edge with text similarity for edge in graph["edges"]: if edge.get("source") == card1 and edge.get("target") == card2: edge["text_similarity"] = float(text_sim) edge["weight"] = edge.get("weight", 0) + float(text_sim) * 0.5 updated_edges += 1 break # Check for functional similarity func_sim = row.get("FUNCTIONAL_SIMILARITY") if pd.notna(func_sim) and func_sim > 0: if edge_key not in existing_edges: graph["edges"].append({ "source": card1, "target": card2, "card1": card1, # Support both formats "card2": card2, "weight": float(func_sim), "type": "functional_similarity", "metadata": {"similarity": float(func_sim)} }) existing_edges.add(edge_key) new_func_edges += 1 else: # Update existing edge with functional similarity for i, edge in enumerate(graph["edges"]): edge_source = edge.get("source") if isinstance(edge, dict) else (edge.card1 if hasattr(edge, "card1") else None) edge_target = edge.get("target") if isinstance(edge, dict) else (edge.card2 if hasattr(edge, "card2") else None) if edge_source == card1 and edge_target == card2: if isinstance(edge, dict): edge["functional_similarity"] = float(func_sim) edge["weight"] = edge.get("weight", 0) + float(func_sim) * 0.7 updated_edges += 1 break # Update nodes if "nodes" not in graph: graph["nodes"] = {} if card1 not in graph["nodes"]: graph["nodes"][card1] = {"neighbors": [], "edge_count": 0} if card2 not in graph["nodes"]: graph["nodes"][card2] = {"neighbors": [], "edge_count": 0} if card2 not in graph["nodes"][card1]["neighbors"]: graph["nodes"][card1]["neighbors"].append(card2) graph["nodes"][card1]["edge_count"] += 1 if card1 not in graph["nodes"][card2]["neighbors"]: graph["nodes"][card2]["neighbors"].append(card1) graph["nodes"][card2]["edge_count"] += 1 # Update metadata if "metadata" not in graph: graph["metadata"] = {} from datetime import datetime graph["metadata"]["last_updated"] = datetime.now().isoformat() graph["metadata"]["new_text_edges"] = new_text_edges graph["metadata"]["new_func_edges"] = new_func_edges graph["metadata"]["updated_edges"] = updated_edges graph["metadata"]["total_edges"] = len(graph["edges"]) graph["metadata"]["total_nodes"] = len(graph["nodes"]) # Save output = output_path or graph_path output.parent.mkdir(parents=True, exist_ok=True) with open(output, 'w') as f: json.dump(graph, f, indent=2) print(f"\n Updated incremental graph:") print(f" New text similarity edges: {new_text_edges:,}") print(f" New functional similarity edges: {new_func_edges:,}") print(f" Updated existing edges: {updated_edges:,}") print(f" Total edges: {len(graph['edges']):,}") print(f" Total nodes: {len(graph['nodes']):,}") print(f" Saved to: {output}") return graph if __name__ == "__main__": import argparse parser = argparse.ArgumentParser(description="Update incremental graph with enhanced edges") parser.add_argument("--graph", type=Path, default="data/graphs/incremental_graph.json", help="Path to incremental graph JSON") parser.add_argument("--pairs", type=Path, required=True, help="Path to enhanced pairs CSV") parser.add_argument("--output", type=Path, help="Output path (defaults to --graph)") args = parser.parse_args() update_incremental_graph_with_enhanced_edges(args.graph, args.pairs, args.output)
