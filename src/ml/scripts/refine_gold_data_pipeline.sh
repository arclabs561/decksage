#!/bin/bash # Comprehensive gold data refinement pipeline # Iteratively improves test sets with more queries and more labels set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)" cd "$PROJECT_ROOT" INPUT="${1:-experiments/test_set_expanded_magic.json}" OUTPUT="${2:-experiments/test_set_refined_magic.json}" ITERATIONS="${3:-3}" NUM_JUDGES="${4:-3}" echo "==========================================" echo "GOLD DATA REFINEMENT PIPELINE" echo "==========================================" echo "Input: $INPUT" echo "Output: $OUTPUT" echo "Iterations: $ITERATIONS" echo "Judges per query: $NUM_JUDGES" echo "" # Step 1: Analyze current quality echo "Step 1/5: Analyzing current quality..." uv run --script src/ml/scripts/analyze_eval_data_quality.py \ "$INPUT" \ --game magic \ --pairs-csv data/processed/pairs_large.csv \ --output experiments/quality_analysis_before.json echo " Quality analysis complete" echo "" # Step 2: Iterative refinement (expand + deepen + re-label) echo "Step 2/5: Iterative refinement (expand queries + deepen labels + re-label low IAA)..." uv run --script src/ml/scripts/iterative_refine_gold_data.py \ --input "$INPUT" \ --output "$OUTPUT" \ --iterations "$ITERATIONS" \ --new-queries-per-iter 20 \ --num-judges "$NUM_JUDGES" \ --min-labels-target 20 \ --min-iaa-target 0.7 if [ ! -f "$OUTPUT" ]; then echo "Error: Refinement failed" exit 1 fi echo " Refinement complete" echo "" # Step 3: Deepen labels for queries still below target echo "Step 3/5: Deepening labels for queries below target..." uv run --script src/ml/scripts/batch_deepen_labels.py \ --input "$OUTPUT" \ --output "$OUTPUT" \ --num-judges "$NUM_JUDGES" \ --target-labels 25 \ --min-current-labels 5 \ --batch-size 10 echo " Deepening complete" echo "" # Step 4: Re-label low quality queries echo "Step 4/5: Re-labeling queries with low IAA or insufficient labels..." uv run --script src/ml/scripts/batch_label_existing_queries.py \ --input "$OUTPUT" \ --output "$OUTPUT" \ --num-judges "$NUM_JUDGES" \ --min-labels 15 \ --replace-fallback \ --batch-size 10 echo " Re-labeling complete" echo "" # Step 5: Final quality analysis echo "Step 5/5: Final quality analysis..." uv run --script src/ml/scripts/analyze_eval_data_quality.py \ "$OUTPUT" \ --game magic \ --pairs-csv data/processed/pairs_large.csv \ --output experiments/quality_analysis_after.json echo " Final analysis complete" echo "" # Summary echo "==========================================" echo "REFINEMENT COMPLETE" echo "==========================================" echo "Input: $INPUT" echo "Output: $OUTPUT" echo "" echo " Compare quality:" echo " Before: experiments/quality_analysis_before.json" echo " After: experiments/quality_analysis_after.json" echo "" echo " Refined test set saved to: $OUTPUT"
