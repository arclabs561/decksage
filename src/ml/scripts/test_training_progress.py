#!/usr/bin/env python3 """ Test training with attribute boost and show progress. Demonstrates the improvements in action. """ import sys import tempfile from pathlib import Path from ml.utils.logging_config import setup_script_logging sys.path.insert(0, str(Path(__file__).parent.parent.parent)) import pandas as pd from ml.scripts.train_multitask_refined import create_multitask_edgelist from ml.utils.pydantic_ai_helpers import get_default_model import logging s: %(message)s') logger = setup_script_logging() def create_test_data(): """Create minimal test dataset.""" return pd.DataFrame({ "NAME_1": [ "Lightning Bolt", "Lightning Bolt", "Brainstorm", "Ponder", "Shock", "Fireblast", "Chain Lightning" ], "NAME_2": [ "Chain Lightning", "Shock", "Ponder", "Preordain", "Lightning Bolt", "Lightning Bolt", "Shock" ], "COUNT_MULTISET": [10, 5, 15, 12, 7, 9, 8], "COUNT_SET": [10, 5, 15, 12, 7, 9, 8], }) def test_training_with_attributes(): """Test training with attribute boost.""" print("\n" + "="*60) print("TESTING TRAINING WITH ATTRIBUTE BOOST") print("="*60) # Create test data test_pairs = create_test_data() substitution_pairs = [ ("Lightning Bolt", "Chain Lightning"), ("Brainstorm", "Ponder"), ] card_attrs_path = Path(__file__).parent.parent.parent.parent / "data" / "processed" / "card_attributes_enriched.csv" print(f"\n Test Data:") print(f" Co-occurrence pairs: {len(test_pairs)}") print(f" Substitution pairs: {len(substitution_pairs)}") print(f" Cards: {len(set(test_pairs['NAME_1'].tolist() + test_pairs['NAME_2'].tolist()))}") # Test without attribute boost print(f"\nüîß Creating edgelist WITHOUT attribute boost...") edges_no_boost = create_multitask_edgelist( pairs_df=test_pairs, substitution_pairs=substitution_pairs, cooccurrence_weight=1.0, substitution_weight=5.0, min_cooccurrence=2, card_attrs_path=None, use_attribute_boost=False, ) print(f" Created {len(edges_no_boost)} edges") print(f" Sample edges:") for i, (n1, n2, weight) in enumerate(edges_no_boost[:3]): print(f" {n1:20} <-> {n2:20} : {weight:.3f}") # Test with attribute boost if card_attrs_path.exists(): print(f"\nüîß Creating edgelist WITH attribute boost...") print(f" Loading attributes from: {card_attrs_path.name}") edges_with_boost = create_multitask_edgelist( pairs_df=test_pairs, substitution_pairs=substitution_pairs, cooccurrence_weight=1.0, substitution_weight=5.0, min_cooccurrence=2, card_attrs_path=card_attrs_path, use_attribute_boost=True, ) print(f" Created {len(edges_with_boost)} edges") print(f" Sample edges (with attribute boost):") for i, (n1, n2, weight) in enumerate(edges_with_boost[:3]): print(f" {n1:20} <-> {n2:20} : {weight:.3f}") # Compare weights print(f"\nüìà Comparison:") print(f" Edges without boost: {len(edges_no_boost)}") print(f" Edges with boost: {len(edges_with_boost)}") # Find edges that changed edge_dict_no = {(n1, n2): w for n1, n2, w in edges_no_boost} edge_dict_with = {(n1, n2): w for n1, n2, w in edges_with_boost} boosted_edges = [] for (n1, n2), w_with in edge_dict_with.items(): w_no = edge_dict_no.get((n1, n2), 0) if w_with > w_no: boosted_edges.append((n1, n2, w_no, w_with, w_with - w_no)) if boosted_edges: print(f"\n Edges boosted by attributes ({len(boosted_edges)}):") for n1, n2, w_no, w_with, boost in boosted_edges[:5]: print(f" {n1:20} <-> {n2:20}") print(f" Before: {w_no:.3f} -> After: {w_with:.3f} (+{boost:.3f})") else: print(f" ‚ÑπÔ∏è No edges were boosted (cards may not have matching attributes)") else: print(f"\nWarning: Card attributes not found, skipping attribute boost test") print(f" Would load from: {card_attrs_path}") print(f"\n Training pipeline works with attribute boost!") if __name__ == "__main__": test_training_with_attributes()
