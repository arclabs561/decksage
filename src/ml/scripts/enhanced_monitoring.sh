#!/bin/bash # Enhanced monitoring script with real-time updates # Based on best practices for ML task monitoring set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)" cd "$PROJECT_ROOT" # Colors for output RED='\033[0;31m' GREEN='\033[0;32m' YELLOW='\033[1;33m' BLUE='\033[0;34m' NC='\033[0m' # No Color echo "üîç Enhanced System Monitoring" echo "============================" echo "" # Function to check process health with resource usage check_process_detailed() { local pattern="$1" local name="$2" pids=$(pgrep -f "$pattern" 2>/dev/null || true) if [ -z "$pids" ]; then echo -e "${RED}Error: $name: Not running${NC}" return 1 fi # Get resource usage for first PID first_pid=$(echo "$pids" | head -1) if ps -p "$first_pid" > /dev/null 2>&1; then stats=$(ps -p "$first_pid" -o pid,pcpu,pmem,etime,command --no-headers 2>/dev/null || echo "") if [ -n "$stats" ]; then pid=$(echo "$stats" | awk '{print $1}') cpu=$(echo "$stats" | awk '{print $2}') mem=$(echo "$stats" | awk '{print $3}') etime=$(echo "$stats" | awk '{print $4}') echo -e "${GREEN} $name: Running${NC}" echo " PID: $pid | CPU: ${cpu}% | MEM: ${mem}% | Runtime: $etime" return 0 fi fi echo -e "${YELLOW}Warning: $name: Process found but stats unavailable${NC}" return 0 } # Card Enrichment echo " Card Enrichment" check_process_detailed "enrich.*scryfall.*optimized" "Enrichment" if [ -f "data/processed/card_attributes_enriched.csv" ]; then progress=$(python3 << 'PYEOF' import csv with open('data/processed/card_attributes_enriched.csv') as f: r = csv.DictReader(f) rows = list(r) enriched = sum(1 for row in rows if row.get('type') and str(row.get('type', '')).strip() and str(row.get('type', '')) != 'nan') total = len(rows) print(f"{enriched}/{total} ({100*enriched/total if total else 0:.1f}%)") PYEOF ) echo " Progress: $progress" tail -1 /tmp/enrichment.log 2>/dev/null | grep -oE '[0-9]+ enriched' | head -1 || echo " Checking..." fi echo "" # Labeling echo "üè∑Ô∏è Test Set Labeling" check_process_detailed "generate_labels.*optimized" "Labeling" if [ -f "experiments/test_set_labeled_magic.json" ]; then progress=$(python3 << 'PYEOF' import json with open('experiments/test_set_labeled_magic.json') as f: d = json.load(f) queries = d.get('queries', d) labeled = sum(1 for q in queries.values() if isinstance(q, dict) and (q.get('highly_relevant') or q.get('relevant'))) total = len(queries) print(f"{labeled}/{total} ({100*labeled/total if total else 0:.1f}%)") PYEOF ) echo " Progress: $progress" tail -1 /tmp/labeling_rerun.log 2>/dev/null | grep -E "(Generated|Processing|batch)" | tail -1 | cut -c1-60 || echo " Processing..." fi echo "" # Hyperparameter Search echo "üî¨ Hyperparameter Search" if pgrep -f "hyperparam|runctl.*aws.*train" > /dev/null; then echo -e "${GREEN} Process running${NC}" else echo -e "${YELLOW}Warning: Process not found${NC}" fi if [ -f "/tmp/hyperparam_search.log" ]; then tail -3 /tmp/hyperparam_search.log 2>&1 | grep -E "(Instance|Starting|error|Created)" | tail -1 || echo " Check log for details" fi echo "" # S3 Backup echo "‚òÅÔ∏è S3 Backup" check_process_detailed "sync_to_s3" "Backup" if [ -f "/tmp/s3_backup.log" ]; then tail -2 /tmp/s3_backup.log 2>&1 | tail -1 | cut -c1-60 || echo " Syncing..." fi echo "" # AWS Instances echo "‚òÅÔ∏è AWS Instances" aws ec2 describe-instances \ --filters "Name=instance-state-name,Values=running,pending" \ --query 'Reservations[*].Instances[*].[InstanceId,InstanceType,State.Name,LaunchTime]' \ --output table 2>&1 | head -8 || echo " No instances or AWS error" echo "" # System Resources echo "üíª System Resources" echo " CPU Load: $(uptime | awk -F'load average:' '{print $2}')" echo " Memory: $(vm_stat | grep "Pages free" | awk '{printf "%.1f GB free\n", $3/262144}')" echo "" echo "============================" echo "Run comprehensive diagnostics:" echo " uv run --script src/ml/scripts/comprehensive_diagnostics.py" echo ""