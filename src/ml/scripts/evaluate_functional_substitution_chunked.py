#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [ # "pandas>=2.0.0", # "numpy<2.0.0", # "gensim>=4.3.0", # ] # /// """Evaluate functional embeddings on substitution task (chunked).""" import json import sys from pathlib import Path sys.path.insert(0, str(Path(__file__).parent.parent.parent)) from gensim.models import KeyedVectors from ml.scripts.evaluate_downstream_tasks import evaluate_card_substitution # Load embedding embedding_path = Path("data/embeddings/trained_functional.wv") if not embedding_path.exists(): print(f"Error: Embedding not found: {embedding_path}") sys.exit(1) print(f"Loading embedding: {embedding_path}") embedding = KeyedVectors.load(str(embedding_path)) print(f" Loaded {len(embedding)} cards") # Load substitution pairs pairs_path = Path("experiments/downstream_tests/substitution_magic_expanded_100.json") with open(pairs_path) as f: pairs_data = json.load(f) if isinstance(pairs_data, list): test_pairs = [tuple(p) if isinstance(p, (list, tuple)) else (p[0], p[1]) for p in pairs_data] else: test_pairs = [] print(f"Evaluating on {len(test_pairs)} substitution pairs...") # Evaluate in chunks chunk_size = 20 results = [] for i in range(0, len(test_pairs), chunk_size): chunk = test_pairs[i:i+chunk_size] print(f" Processing chunk {i//chunk_size + 1}/{(len(test_pairs) + chunk_size - 1)//chunk_size}...") chunk_result = evaluate_card_substitution( embedding=embedding, test_pairs=chunk, game="magic", top_k=10, ) results.append(chunk_result) # Print chunk results if chunk_result.get("total_pairs", 0) > 0: p_at_10 = chunk_result.get("p@10", 0.0) found = chunk_result.get("found_substitute", 0) total = chunk_result.get("total_pairs", 0) print(f" Chunk: P@10={p_at_10:.3f}, Found={found}/{total}") # Aggregate results total_pairs = sum(r.get("total_pairs", 0) for r in results) total_found = sum(r.get("found_substitute", 0) for r in results) total_p_at_1 = sum(r.get("p@1", 0.0) * r.get("total_pairs", 0) for r in results) total_p_at_5 = sum(r.get("p@5", 0.0) * r.get("total_pairs", 0) for r in results) total_p_at_10 = sum(r.get("p@10", 0.0) * r.get("total_pairs", 0) for r in results) final_result = { "embedding": "trained_functional.wv", "task": "substitution", "total_pairs": total_pairs, "found_substitute": total_found, "p@1": total_p_at_1 / total_pairs if total_pairs > 0 else 0.0, "p@5": total_p_at_5 / total_pairs if total_pairs > 0 else 0.0, "p@10": total_p_at_10 / total_pairs if total_pairs > 0 else 0.0, } print() print("=" * 70) print("FINAL RESULTS") print("=" * 70) print(f"Total pairs: {final_result['total_pairs']}") print(f"Found substitutes: {final_result['found_substitute']}") print(f"P@1: {final_result['p@1']:.3f}") print(f"P@5: {final_result['p@5']:.3f}") print(f"P@10: {final_result['p@10']:.3f}") # Save results output_path = Path("experiments/functional_substitution_evaluation.json") with open(output_path, "w") as f: json.dump(final_result, f, indent=2) print(f" Saved to {output_path}")
