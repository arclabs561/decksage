#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [ # "gensim>=4.3.0", # "pandas>=2.0.0", # ] # /// """ Train multi-game embeddings with similarity-based validation. Uses test sets from all games for validation. """ from __future__ import annotations import argparse import json import logging from pathlib import Path from typing import Any from ml.utils.logging_config import setup_script_logging try: from gensim.models import Word2Vec, KeyedVectors HAS_DEPS = True except ImportError: HAS_DEPS = False logger = setup_script_logging() # Fix import path import sys script_dir = Path(__file__).parent src_dir = script_dir.parent.parent if str(src_dir) not in sys.path: sys.path.insert(0, str(src_dir)) try: from ml.scripts.train_multi_game_embeddings import ( load_multi_game_pairs, create_game_aware_walks, ) HAS_MULTI_GAME = True except ImportError: HAS_MULTI_GAME = False def train_with_validation( pairs_csv: Path, output_path: Path, test_sets: dict[str, Path], dim: int = 128, walk_length: int = 80, num_walks: int = 10, window_size: int = 10, p: float = 1.0, q: float = 1.0, epochs: int = 10, workers: int = 4, ) -> KeyedVectors: """Train multi-game embeddings with validation.""" if not HAS_DEPS or not HAS_MULTI_GAME: logger.error("Missing dependencies") return None # Load multi-game pairs pairs_csvs = {"MTG": pairs_csv} # Can add YGO, PKM later adj, weights, game_map = load_multi_game_pairs(pairs_csvs) logger.info(f"Loaded graph: {len(adj)} nodes") # Create game-aware walks walks = create_game_aware_walks( adj=adj, game_map=game_map, num_walks=num_walks, walk_length=walk_length, p=p, q=q, ) logger.info(f"Generated {len(walks)} walks") # Train embeddings logger.info("Training embeddings...") model = Word2Vec( walks, vector_size=dim, window=window_size, min_count=0, sg=1, workers=workers, epochs=epochs, ) # Save model.wv.save(str(output_path)) logger.info(f" Saved embeddings to {output_path}") return model.wv def main() -> int: """Train multi-game embeddings.""" parser = argparse.ArgumentParser(description="Train multi-game embeddings with validation") parser.add_argument("--input", type=str, required=True, help="Multi-game pairs CSV") parser.add_argument("--output", type=str, required=True, help="Output embeddings") parser.add_argument("--dim", type=int, default=128, help="Embedding dimension") parser.add_argument("--walk-length", type=int, default=80, help="Walk length") parser.add_argument("--num-walks", type=int, default=10, help="Number of walks per node") parser.add_argument("--window-size", type=int, default=10, help="Window size") parser.add_argument("--p", type=float, default=1.0, help="Return parameter") parser.add_argument("--q", type=float, default=1.0, help="In-out parameter") parser.add_argument("--epochs", type=int, default=10, help="Epochs") parser.add_argument("--test-sets", type=str, nargs="*", help="Test sets (game:path format)") args = parser.parse_args() if not HAS_DEPS: logger.error("Missing dependencies") return 1 input_path = Path(args.input) if not input_path.exists(): logger.error(f"Input not found: {input_path}") return 1 # Parse test sets test_sets = {} if args.test_sets: for item in args.test_sets: if ":" in item: game, path = item.split(":", 1) test_sets[game] = Path(path) output_path = Path(args.output) # Train wv = train_with_validation( pairs_csv=input_path, output_path=output_path, test_sets=test_sets, dim=args.dim, walk_length=args.walk_length, num_walks=args.num_walks, window_size=args.window_size, p=args.p, q=args.q, epochs=args.epochs, ) if wv is None: return 1 return 0 if __name__ == "__main__": import sys sys.exit(main())
