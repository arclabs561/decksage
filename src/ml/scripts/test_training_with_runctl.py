#!/usr/bin/env python3 """ Test training with runctl (local mode). Creates synthetic data and tests: 1. Training with checkpointing 2. Resume from checkpoint 3. S3 sync (if configured) """ import json import tempfile from pathlib import Path try: import pandas as pd from gensim.models import KeyedVectors HAS_DEPS = True except ImportError: HAS_DEPS = False def create_test_pairs_csv(output_path: Path) -> Path: """Create small test pairs CSV.""" pairs_data = { "NAME_1": ["Lightning Bolt", "Lightning Bolt", "Chain Lightning", "Brainstorm", "Ponder", "Shock", "Fireblast"], "NAME_2": ["Chain Lightning", "Shock", "Shock", "Ponder", "Preordain", "Lightning Bolt", "Lightning Bolt"], "COUNT_MULTISET": [10, 5, 8, 15, 12, 7, 9], "COUNT_SET": [10, 5, 8, 15, 12, 7, 9], } pairs_df = pd.DataFrame(pairs_data) pairs_df.to_csv(output_path, index=False) return output_path def test_training_local(): """Test training locally with runctl.""" if not HAS_DEPS: print("Error: Missing dependencies") return False print("ðŸ§ª Testing training with runctl (local mode)...") # Create test data with tempfile.TemporaryDirectory() as tmpdir: tmp_path = Path(tmpdir) pairs_csv = tmp_path / "test_pairs.csv" output_wv = tmp_path / "test_embeddings.wv" checkpoint_dir = tmp_path / "checkpoints" create_test_pairs_csv(pairs_csv) print(f" Created test data: {pairs_csv}") # Test training with runctl local import subprocess runctl_path = Path(__file__).parent.parent.parent.parent / "runctl" / "target" / "release" / "runctl" if not runctl_path.exists(): print(f"Warning: runctl not found at {runctl_path}, testing direct Python execution") # Fallback to direct execution from ml.scripts.improve_training_with_validation_enhanced import train_with_validation, prepare_edgelist_with_split # Prepare splits train_edg = tmp_path / "train.edg" val_edg = tmp_path / "val.edg" test_edg = tmp_path / "test.edg" prepare_edgelist_with_split(pairs_csv, train_edg, val_edg, test_edg) # Train wv = train_with_validation( train_edg, val_edg, dim=32, walk_length=10, num_walks=2, window_size=5, p=1.0, q=1.0, epochs=3, checkpoint_dir=checkpoint_dir, checkpoint_interval=1, ) # Verify assert isinstance(wv, KeyedVectors) assert len(wv) > 0 print(f" Training complete: {len(wv)} cards, dim={wv.vector_size}") # Check checkpoints checkpoints = list(checkpoint_dir.glob("checkpoint_epoch_*.wv")) print(f" Checkpoints created: {len(checkpoints)}") # Test resume if checkpoints: latest = max(checkpoints, key=lambda p: int(p.stem.split("_")[-1])) print(f" Testing resume from {latest.name}...") wv2 = train_with_validation( train_edg, val_edg, dim=32, walk_length=10, num_walks=2, window_size=5, p=1.0, q=1.0, epochs=5, # More epochs resume_from=latest, checkpoint_dir=checkpoint_dir, checkpoint_interval=1, ) print(f" Resume successful: {len(wv2)} cards") print(" All training tests passed") return True else: # Use runctl cmd = [ str(runctl_path), "local", "src/ml/scripts/improve_training_with_validation_enhanced.py", "--input", str(pairs_csv), "--output", str(output_wv), "--dim", "32", "--walk-length", "10", "--num-walks", "2", "--window-size", "5", "--epochs", "3", "--checkpoint-dir", str(checkpoint_dir), "--checkpoint-interval", "1", ] print(f" Running: {' '.join(cmd)}") result = subprocess.run(cmd, capture_output=True, text=True, cwd=Path(__file__).parent.parent.parent.parent) if result.returncode == 0: print(" Training with runctl successful") # Check outputs if output_wv.exists(): wv = KeyedVectors.load(str(output_wv)) print(f" Embeddings saved: {len(wv)} cards") checkpoints = list(checkpoint_dir.glob("checkpoint_epoch_*.wv")) if checkpoints: print(f" Checkpoints created: {len(checkpoints)}") # Test resume latest = max(checkpoints, key=lambda p: int(p.stem.split("_")[-1])) print(f" Testing resume from {latest.name}...") cmd2 = cmd.copy() cmd2.extend(["--resume-from", str(latest), "--epochs", "5"]) result2 = subprocess.run(cmd2, capture_output=True, text=True, cwd=Path(__file__).parent.parent.parent.parent) if result2.returncode == 0: print(" Resume with runctl successful") else: print(f" Warning: Resume failed: {result2.stderr}") print(" All runctl tests passed") return True else: print(f" Error: Training failed: {result.stderr}") return False if __name__ == "__main__": import sys success = test_training_local() sys.exit(0 if success else 1)
