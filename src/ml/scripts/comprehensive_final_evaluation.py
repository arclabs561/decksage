#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [ # "pandas>=2.0.0", # "numpy<2.0.0", # "gensim>=4.3.0", # ] # /// """Comprehensive final evaluation of all embeddings.""" import json import sys from pathlib import Path sys.path.insert(0, str(Path(__file__).parent.parent.parent)) from gensim.models import KeyedVectors # All embeddings to evaluate embeddings = { "functional": "data/embeddings/trained_functional.wv", "functional_improved": "data/embeddings/trained_functional_improved.wv", "functional_text": "data/embeddings/trained_functional_text.wv", "contrastive": "data/embeddings/trained_contrastive_substitution.wv", "heterogeneous": "data/embeddings/trained_heterogeneous_substitution.wv", "triplet": "data/embeddings/trained_triplet_substitution.wv", } # Load test sets similarity_test = Path("experiments/test_set_unified_magic.json") substitution_test = Path("experiments/downstream_tests/substitution_magic_expanded_100.json") print("=" * 70) print("COMPREHENSIVE FINAL EVALUATION") print("=" * 70) print() results = {} # Evaluate on similarity task if similarity_test.exists(): print(" SIMILARITY TASK:") with open(similarity_test) as f: sim_data = json.load(f) sim_queries = sim_data.get("queries", sim_data) if isinstance(sim_data, dict) else sim_data for emb_name, emb_path in embeddings.items(): emb_file = Path(emb_path) if not emb_file.exists(): continue embedding = KeyedVectors.load(str(emb_file)) total_p_at_10 = 0 for query, labels in list(sim_queries.items())[:50]: # Sample 50 queries if query not in embedding: continue relevant = ( labels.get("highly_relevant", []) + labels.get("relevant", []) + labels.get("somewhat_relevant", []) ) if not relevant: continue try: similar = embedding.most_similar(query, topn=10) predictions = [card for card, _ in similar] for pred in predictions: if pred in relevant: total_p_at_10 += 1 break except Exception: continue p_at_10 = total_p_at_10 / min(50, len(sim_queries)) if sim_queries else 0.0 if emb_name not in results: results[emb_name] = {} results[emb_name]["similarity_p@10"] = p_at_10 print(f" {emb_name:20s}: P@10={p_at_10:.3f}") print() # Evaluate on substitution task if substitution_test.exists(): print(" SUBSTITUTION TASK:") with open(substitution_test) as f: sub_data = json.load(f) if isinstance(sub_data, list): test_pairs = [tuple(p) if isinstance(p, (list, tuple)) else (p[0], p[1]) for p in sub_data] else: test_pairs = [] for emb_name, emb_path in embeddings.items(): emb_file = Path(emb_path) if not emb_file.exists(): continue embedding = KeyedVectors.load(str(emb_file)) total_found = 0 total_p_at_10 = 0 for original, target in test_pairs: if original not in embedding: continue try: similar = embedding.most_similar(original, topn=50) predictions = [card for card, _ in similar] for rank, pred in enumerate(predictions, 1): if pred == target: total_found += 1 if rank <= 10: total_p_at_10 += 1 break except Exception: continue p_at_10 = total_p_at_10 / len(test_pairs) if test_pairs else 0.0 if emb_name not in results: results[emb_name] = {} results[emb_name]["substitution_p@10"] = p_at_10 results[emb_name]["substitution_found"] = total_found print(f" {emb_name:20s}: P@10={p_at_10:.3f} ({total_found}/{len(test_pairs)})") print() # Save results output_path = Path("experiments/comprehensive_final_evaluation.json") with open(output_path, "w") as f: json.dump(results, f, indent=2) print("=" * 70) print("FINAL RANKINGS") print("=" * 70) print() print("Similarity Task:") sim_rankings = sorted( [(name, r.get("similarity_p@10", 0.0)) for name, r in results.items()], key=lambda x: x[1], reverse=True ) for i, (name, score) in enumerate(sim_rankings, 1): print(f" {i}. {name:20s}: P@10={score:.3f}") print() print("Substitution Task:") sub_rankings = sorted( [(name, r.get("substitution_p@10", 0.0)) for name, r in results.items()], key=lambda x: x[1], reverse=True ) for i, (name, score) in enumerate(sub_rankings, 1): found = results[name].get("substitution_found", 0) print(f" {i}. {name:20s}: P@10={score:.3f} (Found: {found})") print() print(f" Saved to {output_path}")