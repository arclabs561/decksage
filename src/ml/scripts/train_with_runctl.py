#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [] # /// """ Unified training script using runctl. This script replaces direct AWS/SSM calls with runctl for consistent instance management, monitoring, and S3 integration. """ from __future__ import annotations import argparse import subprocess import sys from pathlib import Path def find_runctl() -> Path | None: """Find runctl binary.""" project_root = Path(__file__).parent.parent.parent.parent runctl_path = project_root.parent / "runctl" / "target" / "release" / "runctl" if runctl_path.exists(): return runctl_path # Try alternative locations alt_paths = [ Path.home() / ".cargo" / "bin" / "runctl", Path("/usr/local/bin/runctl"), Path("/usr/bin/runctl"), ] for alt_path in alt_paths: if alt_path.exists(): return alt_path return None def run_with_runctl( script_path: str, instance_id: str | None = None, local: bool = False, create_instance: bool = False, instance_type: str = "g4dn.xlarge", spot: bool = True, script_args: list[str] | None = None, output_s3: str | None = None, ) -> int: """Run a script with runctl.""" runctl_path = find_runctl() if not runctl_path: print("Error: runctl not found. Build it first:") print(" cd ../runctl && cargo build --release") return 1 script_args = script_args or [] # Create instance if needed if create_instance and not instance_id: print(f"Creating AWS instance ({instance_type}, spot={spot})...") create_cmd = [ str(runctl_path), "aws", "create", "--spot" if spot else "", instance_type, ] create_cmd = [c for c in create_cmd if c] # Remove empty strings try: result = subprocess.run( create_cmd, capture_output=True, text=True, check=True, ) # Extract instance ID from output import re instance_match = re.search(r'i-[a-z0-9]+', result.stdout) if instance_match: instance_id = instance_match.group(0) print(f" Instance created: {instance_id}") else: print(f"Error: Could not extract instance ID from: {result.stdout}") return 1 except subprocess.CalledProcessError as e: print(f"Error: Failed to create instance: {e.stderr}") return 1 if not instance_id and not local: print("Error: No instance ID provided and not running locally") return 1 # Build runctl command if local: cmd = [ str(runctl_path), "local", script_path, ] + script_args else: cmd = [ str(runctl_path), "aws", "train", instance_id, script_path, ] if output_s3: cmd.extend(["--output-s3", output_s3]) cmd.append("--") cmd.extend(script_args) print(f" Running: {' '.join(cmd)}") try: subprocess.run(cmd, check=True) return 0 except subprocess.CalledProcessError as e: print(f"Error: Training failed: {e}") return 1 except KeyboardInterrupt: print("\n⏸️ Interrupted (training may continue on instance)") return 130 def main() -> int: """Main entry point.""" parser = argparse.ArgumentParser( description="Train embeddings using runctl (unified interface)", formatter_class=argparse.RawDescriptionHelpFormatter, ) parser.add_argument( "script", type=str, help="Training script to run (e.g., src/ml/scripts/improve_training_with_validation_enhanced.py)", ) parser.add_argument( "--local", action="store_true", help="Run locally instead of on AWS", ) parser.add_argument( "--instance", type=str, default=None, help="AWS instance ID (or use --create to create new)", ) parser.add_argument( "--create", action="store_true", help="Create new AWS instance", ) parser.add_argument( "--instance-type", type=str, default="g4dn.xlarge", help="Instance type for new instances (default: g4dn.xlarge)", ) parser.add_argument( "--no-spot", action="store_true", help="Don't use spot instances", ) parser.add_argument( "--output-s3", type=str, default="s3://games-collections/experiments/", help="S3 path for outputs (default: s3://games-collections/experiments/)", ) parser.add_argument( "script_args", nargs=argparse.REMAINDER, help="Arguments to pass to the training script", ) args = parser.parse_args() # Validate script exists script_path = Path(args.script) if not script_path.exists(): print(f"Error: Script not found: {script_path}") return 1 return run_with_runctl( script_path=str(script_path), instance_id=args.instance, local=args.local, create_instance=args.create, instance_type=args.instance_type, spot=not args.no_spot, script_args=args.script_args, output_s3=args.output_s3 if not args.local else None, ) if __name__ == "__main__": sys.exit(main())
