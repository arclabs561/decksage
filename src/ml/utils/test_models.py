#!/usr/bin/env python3 """ Test script for model improvements. Validates that all models work correctly with new enums and validators. """ import sys from pathlib import Path # Add src to path sys.path.insert(0, str(Path(__file__).parent.parent.parent)) try: from pydantic import ValidationError from ml.utils.shared_models import ( SimilarityTypeEnum, UseCaseEnum, DifficultyEnum, PrimaryFunctionEnum, PowerLevelEnum, ) from ml.annotation.llm_annotator import ( CardSimilarityAnnotation, ArchetypeDescription, CardSubstitution, DeckSynergy, CardFunctionality, ) from ml.annotation.llm_judge_batch import SimilarityJudgment, BatchJudgment from ml.api.api import SimilarCard, SimilarityRequest, SimilarityResponse, CompleteRequest from ml.evaluation.comprehensive_judge import ComprehensiveJudgment print(" All imports successful") except ImportError as e: print(f"Error: Import error: {e}") sys.exit(1) def test_card_similarity_annotation(): """Test CardSimilarityAnnotation model.""" print("\nðŸ§ª Testing CardSimilarityAnnotation...") # Valid model valid = CardSimilarityAnnotation( card1="Lightning Bolt", card2="Chain Lightning", similarity_score=0.85, similarity_type=SimilarityTypeEnum.FUNCTIONAL, reasoning="Both are 1-mana red burn spells", is_substitute=True, context_dependent=False, ) assert valid.card1 == "Lightning Bolt" assert valid.similarity_type == SimilarityTypeEnum.FUNCTIONAL print(" Valid model created") # Invalid: empty card name try: CardSimilarityAnnotation( card1="", card2="Chain Lightning", similarity_score=0.85, similarity_type=SimilarityTypeEnum.FUNCTIONAL, reasoning="Test", is_substitute=True, ) print(" Error: Should have raised ValidationError for empty card1") return False except ValidationError: print(" Correctly rejected empty card name") # Invalid: out of range score try: CardSimilarityAnnotation( card1="Lightning Bolt", card2="Chain Lightning", similarity_score=1.5, # > 1.0 similarity_type=SimilarityTypeEnum.FUNCTIONAL, reasoning="Test", is_substitute=True, ) print(" Error: Should have raised ValidationError for score > 1.0") return False except ValidationError: print(" Correctly rejected invalid score") return True def test_similarity_request(): """Test SimilarityRequest model.""" print("\nðŸ§ª Testing SimilarityRequest...") # Valid request valid = SimilarityRequest( query="Lightning Bolt", top_k=10, use_case=UseCaseEnum.substitute, ) assert valid.query == "Lightning Bolt" assert valid.use_case == UseCaseEnum.substitute print(" Valid request created") # Invalid: empty query try: SimilarityRequest(query="", top_k=10) print(" Error: Should have raised ValidationError for empty query") return False except ValidationError: print(" Correctly rejected empty query") # Invalid: top_k too large try: SimilarityRequest(query="Lightning Bolt", top_k=200) # > 100 print(" Error: Should have raised ValidationError for top_k > 100") return False except ValidationError: print(" Correctly rejected invalid top_k") return True def test_comprehensive_judgment(): """Test ComprehensiveJudgment model.""" print("\nðŸ§ª Testing ComprehensiveJudgment...") # Valid judgment valid = ComprehensiveJudgment( relevance=3, explanation_quality=4, deck_balance_impact=2, power_level_match=3, card_availability=4, temporal_context_appropriate=3, meta_shift_awareness=2, price_volatility_awareness=1, ban_timeline_awareness=4, reasoning="Good card for the deck", ) assert valid.relevance == 3 print(" Valid judgment created") # Invalid: empty reasoning try: ComprehensiveJudgment( relevance=3, explanation_quality=4, deck_balance_impact=2, power_level_match=3, card_availability=4, temporal_context_appropriate=3, meta_shift_awareness=2, price_volatility_awareness=1, ban_timeline_awareness=4, reasoning="", ) print(" Error: Should have raised ValidationError for empty reasoning") return False except ValidationError: print(" Correctly rejected empty reasoning") return True def test_deck_synergy(): """Test DeckSynergy model with consistency validation.""" print("\nðŸ§ª Testing DeckSynergy...") # Valid synergy valid = DeckSynergy( card="Brainstorm", synergy_cards=["Ponder", "Preordain"], synergy_explanations={ "Ponder": "Both are card selection", "Preordain": "Similar function", }, ) assert len(valid.synergy_cards) == 2 print(" Valid synergy created") # Invalid: explanation key not in synergy_cards try: DeckSynergy( card="Brainstorm", synergy_cards=["Ponder"], synergy_explanations={ "Ponder": "Good", "Preordain": "Not in list", # Not in synergy_cards }, ) print(" Error: Should have raised ValidationError for mismatched keys") return False except ValidationError: print(" Correctly rejected mismatched explanation keys") return True def main(): """Run all tests.""" print("=" * 60) print("Model Validation Tests") print("=" * 60) tests = [ test_card_similarity_annotation, test_similarity_request, test_comprehensive_judgment, test_deck_synergy, ] passed = 0 failed = 0 for test in tests: try: if test(): passed += 1 else: failed += 1 except Exception as e: print(f" Error: Test failed with exception: {e}") import traceback traceback.print_exc() failed += 1 print("\n" + "=" * 60) print(f"Results: {passed} passed, {failed} failed") print("=" * 60) return 0 if failed == 0 else 1 if __name__ == "__main__": sys.exit(main())
