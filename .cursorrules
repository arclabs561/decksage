# DeckSage Project Rules

## Code Style
- Use PEP 723 scripts for standalone tools (`# /// script`)
- Prefer `uv` over `pip` for package management
- Use type hints (Python 3.11+)
- Follow existing patterns in `src/ml/`
- Use `fd` not `find`, `rg` not `grep`, `bat` not `cat`

## Priorities
1. Embedding quality (P@10 target: 0.15-0.20, current: ~0.08)
2. Evaluation rigor (test set expansion, IAA tracking)
3. Downstream task performance (deck completion, substitution)
4. Multi-modal fusion (embedding + Jaccard + functional + text)

## Training
- Use `runctl` for all training (local, AWS, RunPod)
- Always use `--data-s3` and `--output-s3` for cloud training
- Enable checkpointing for long runs (`--checkpoint-interval`)
- Use `--resume-from` to resume interrupted training
- Primary training data: `pairs_large.csv` (7.5M pairs) or `decks_all_final.jsonl` (69K decks)

## Testing
- Run `pytest src/ml/tests/` before committing
- Use property-based tests for invariants
- Test LLM calls with caching (diskcache)
- Mark slow tests with `@pytest.mark.slow`
- Use `make test` (not `uv run pytest`) to avoid collection overhead

## Data
- S3 bucket: `s3://games-collections/`
- Test sets: `experiments/test_set_canonical_*.json` (canonical) or `test_set_expanded_*.json` (analysis)
- Embeddings: `data/embeddings/*.wv`
- Processed decks: `data/processed/decks_all_final.jsonl` (recommended, 69K decks, enhanced)
- Always sync critical data to S3 using `just sync-s3`
- Use `PATHS` from `src/ml/utils/paths.py` instead of hardcoded paths

## Evaluation
- Use canonical test sets for production (`test_set_canonical_*.json`)
- Use expanded test sets for comprehensive analysis
- Evaluate on downstream tasks, not just similarity
- Track Inter-Annotator Agreement (IAA) for labels
- Use confidence intervals for metrics

## Pipeline Coherence
- Training data flow: canonical → export → enhance → train
- Local training: uses `data/processed/` paths
- AWS training: uses `s3://games-collections/processed/` paths
- All deck data: use `decks_all_final.jsonl` (enhanced, normalized, deduplicated)
- Sync scripts: `scripts/sync_all_to_s3.sh` (comprehensive) or `scripts/sync_to_s3.sh` (selective)

## Anti-Sycophancy
- Challenge assumptions, don't just agree
- Identify issues before implementation
- Present alternatives with trade-offs
- Use direct technical language, avoid validation phrases

## Documentation
- Don't create excessive MD files for progress
- Improve code and comments as primary documentation
- Use code references for existing code, markdown blocks for new code
- Keep README.md current, archive outdated docs
