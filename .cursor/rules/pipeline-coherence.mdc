---
description: Pipeline data flow, path handling, concurrency, and lineage enforcement
globs:
  - "scripts/**/*.py"
  - "scripts/**/*.sh"
  - "src/ml/scripts/**"
alwaysApply: false
---

# Pipeline Coherence

- Training data flow: canonical → export → enhance → train
- Local training: uses `data/processed/` paths
- AWS training: uses `s3://games-collections/processed/` paths (or EBS volume if mounted)
- All deck data: use `decks_all_final.jsonl` (enhanced, normalized, deduplicated)
- Sync scripts: `scripts/sync_all_to_s3.sh` (comprehensive) or `scripts/sync_to_s3.sh` (selective)
- **Path handling**: Scripts should work with both S3 paths (for initial sync) and local paths (for EBS-mounted data)
  - Check EBS volume first (`/mnt/data`), then local paths, then S3 download
  - Use `pathlib.Path` for path operations, not string concatenation
  - **Path examples**: `Path("data") / "processed" / f"{game}_decks.jsonl"` not `"data/processed/" + game + "_decks.jsonl"`
  - Use `.exists()`, `.mkdir(parents=True)`, `.read_text()`, `.write_text()` methods
- **Concurrency**: Use `ThreadPoolExecutor` for I/O-bound tasks, `ProcessPoolExecutor` for CPU-bound tasks
  - Limit concurrency to avoid overwhelming APIs or databases
  - Use `asyncio` for async operations (API calls, database queries)
  - Always handle exceptions in concurrent code - one failure shouldn't crash the entire batch
- **Lineage enforcement**:
  - Before processing Order N data, validate that Order N-1 dependencies exist
  - Use `validate_lineage.py` in automation scripts
  - Never write to Order 0 locations (immutable)
  - Document input/output orders in all data processing scripts
