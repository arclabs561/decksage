#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [] # /// """ Create test sets for new games (Digimon, One Piece, Riftbound). Uses LLM to generate queries and samples from exported decks. DATA LINEAGE: Order 5 (depends on Order 1: Exported Decks) - Input: data/processed/decks_{game}_{source}.jsonl (Order 1) - Output: experiments/test_set_unified_{game}.json (Order 5) - Can be regenerated from Order 1 data """ import argparse import json import sys from pathlib import Path from typing import Any # Add src to path script_dir = Path(__file__).parent src_dir = script_dir.parent.parent / "src" if str(src_dir) not in sys.path: sys.path.insert(0, str(src_dir)) from ml.utils.paths import PATHS def sample_decks(deck_file: Path, num_samples: int = 50) -> list[dict[str, Any]]: """Sample decks from JSONL file.""" if not deck_file.exists(): return [] decks = [] with open(deck_file) as f: for line in f: if line.strip(): try: deck = json.loads(line) decks.append(deck) if len(decks) >= num_samples * 2: # Sample from larger pool break except json.JSONDecodeError: continue # Return evenly spaced samples if len(decks) <= num_samples: return decks step = len(decks) // num_samples return [decks[i] for i in range(0, len(decks), step)][:num_samples] def generate_queries_from_decks( game: str, decks: list[dict[str, Any]], num_queries: int = 50, ) -> list[dict[str, Any]]: """Generate test queries from sampled decks.""" queries = [] # Extract card names from decks all_cards = set() for deck in decks: if "cards" in deck: for card in deck["cards"]: if isinstance(card, dict): all_cards.add(card.get("name", "")) else: all_cards.add(str(card)) elif "partitions" in deck: for partition in deck.get("partitions", []): for card in partition.get("cards", []): if isinstance(card, dict): all_cards.add(card.get("name", "")) else: all_cards.add(str(card)) all_cards = sorted([c for c in all_cards if c])[:200] # Limit to 200 cards # Generate queries (simple approach - can be enhanced with LLM) # For now, create queries from sampled cards step = max(1, len(all_cards) // num_queries) for i in range(0, len(all_cards), step): if len(queries) >= num_queries: break card_name = all_cards[i] queries.append({ "query": card_name, "game": game, "type": "similarity", "expected_results": [], # Will be filled by evaluation }) return queries[:num_queries] def create_test_set( game: str, deck_file: Path, output_file: Path, num_queries: int = 50, ) -> int: """Create test set for a game.""" if not deck_file.exists(): print(f"Warning: Deck file not found: {deck_file}") return 0 print(f"Creating test set for {game}...") print(f" Reading decks from: {deck_file}") # Sample decks decks = sample_decks(deck_file, num_queries) print(f" Sampled {len(decks)} decks") # Generate queries queries = generate_queries_from_decks(game, decks, num_queries) print(f" Generated {len(queries)} queries") # Create test set structure test_set = { "game": game, "version": "1.0", "created_at": "2025-01-02", "queries": queries, "metadata": { "source_deck_file": str(deck_file), "num_decks_sampled": len(decks), "num_queries": len(queries), } } # Write output output_file.parent.mkdir(parents=True, exist_ok=True) with open(output_file, "w") as f: json.dump(test_set, f, indent=2) print(f" Created test set: {output_file}") return len(queries) def main() -> int: parser = argparse.ArgumentParser(description="Create test sets for new games") parser.add_argument("--game", choices=["digimon", "onepiece", "riftbound", "all"], default="all", help="Game to create test set for") parser.add_argument("--input-dir", type=Path, default=PATHS.processed, help="Input directory with deck files") parser.add_argument("--output-dir", type=Path, default=PATHS.experiments, help="Output directory for test sets") parser.add_argument("--num-queries", type=int, default=50, help="Number of queries per test set") args = parser.parse_args() games_to_process = ["digimon", "onepiece", "riftbound"] if args.game == "all" else [args.game] print("=" * 80) print("CREATING TEST SETS FOR NEW GAMES") print("=" * 80) print() total_queries = 0 for game in games_to_process: # Find deck file deck_files = list(args.input_dir.glob(f"decks_{game}_*.jsonl")) if not deck_files: print(f"Warning: No deck files found for {game}") continue # Use first available deck file deck_file = deck_files[0] output_file = args.output_dir / f"test_set_unified_{game}.json" queries = create_test_set(game, deck_file, output_file, args.num_queries) total_queries += queries print() print("=" * 80) print(f" Created test sets with {total_queries} total queries") print("=" * 80) return 0 if __name__ == "__main__": sys.exit(main())