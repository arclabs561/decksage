#!/usr/bin/env python3 """ Generate negative examples (marginally_relevant, irrelevant) for Magic test set. Uses LLM to identify cards that are tangentially related or completely unrelated. """ import sys from pathlib import Path # Add src to path sys.path.insert(0, str(Path(__file__).parent.parent.parent)) from ml.utils.pydantic_ai_helpers import make_agent, get_default_model from ml.utils.llm_cost_tracker import record_usage import json def generate_negative_examples(query: str, positive_cards: list, num_negative: int = 5): """Generate negative examples for a query.""" model = get_default_model("annotator") agent = make_agent( model=model, system_prompt="""You are an expert at Magic: The Gathering card evaluation. Given a query card and some positive examples, generate negative examples: - marginally_relevant: Cards that are tangentially related but not actually good matches - irrelevant: Cards that are completely unrelated Return JSON with marginally_relevant and irrelevant arrays.""", ) prompt = f"""Query: {query} Positive examples: {', '.join(positive_cards[:5])} Generate {num_negative} negative examples (mix of marginally_relevant and irrelevant).""" result = agent.run(prompt) record_usage(model, result) # Parse result try: data = json.loads(result.data) return data except: return {"marginally_relevant": [], "irrelevant": []} if __name__ == "__main__": # Load Magic test set magic_path = Path("experiments/test_set_unified_magic.json") with open(magic_path, 'rb') as f: data = json.load(f) queries = data.get('queries', {}) # Find queries without negative examples queries_needing_negatives = [] for query, labels in queries.items(): if len(labels.get('marginally_relevant', [])) == 0 and len(labels.get('irrelevant', [])) == 0: positive = labels.get('highly_relevant', []) + labels.get('relevant', []) if positive: queries_needing_negatives.append((query, positive)) print(f"Found {len(queries_needing_negatives)} queries needing negative examples") print("Generating negative examples for first 10 queries...") # Generate for first 10 for query, positive in queries_needing_negatives[:10]: negatives = generate_negative_examples(query, positive, num_negative=5) queries[query]['marginally_relevant'] = negatives.get('marginally_relevant', []) queries[query]['irrelevant'] = negatives.get('irrelevant', []) print(f" {query}: +{len(negatives.get('marginally_relevant', []))} marginally, +{len(negatives.get('irrelevant', []))} irrelevant") # Save updated with open(magic_path, 'w') as f: json.dump(data, f, indent=2) print(f" Updated {magic_path}")
