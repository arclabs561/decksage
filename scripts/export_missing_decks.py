#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [] # /// """ Export missing deck datasets from raw data. Exports Pokemon and Yu-Gi-Oh decks from raw data directories to JSONL format. """ from __future__ import annotations import argparse import json import subprocess import sys from pathlib import Path from typing import Any def export_decks_from_raw( raw_data_dir: Path, output_path: Path, game: str, max_decks: int | None = None, ) -> int: """Export decks from raw data directory using export-hetero tool.""" if not raw_data_dir.exists(): print(f"Error: Raw data directory not found: {raw_data_dir}") return 0 # Check if export-hetero binary exists export_binary = Path("bin/export-hetero") if not export_binary.exists(): # Try to build it print("Building export-hetero...") result = subprocess.run( ["go", "build", "-o", "bin/export-hetero", "src/backend/cmd/export-hetero/main.go"], capture_output=True, text=True, ) if result.returncode != 0: print(f"Error: Failed to build export-hetero: {result.stderr}") return 0 # Create temp output temp_output = output_path.parent / f"{output_path.name}.tmp" print(f"Exporting {game} decks from {raw_data_dir}...") result = subprocess.run( [str(export_binary), str(raw_data_dir), str(temp_output)], capture_output=True, text=True, ) if result.returncode != 0: print(f"Error: Export failed: {result.stderr}") return 0 # Count and optionally limit decks exported = 0 with open(temp_output) as f_in, open(output_path, "w") as f_out: for line in f_in: if max_decks and exported >= max_decks: break f_out.write(line) exported += 1 # Remove temp file temp_output.unlink() print(f" Exported {exported} {game} decks to {output_path}") return exported def export_pokemon_decks(output_path: Path, max_decks: int | None = None) -> int: """Export Pokemon decks from raw data.""" # Try multiple possible locations for deck collections (not cards) possible_dirs = [ Path("data/raw/data-sample/games/games/pokemon"), Path("data/raw/data-full/games/pokemon"), Path("data/raw/games/pokemon"), ] # Look for collection/deck directories (not card directories) for raw_dir in possible_dirs: if raw_dir.exists(): # Look for deck/collection directories (skip 'cards' directories) for subdir in raw_dir.iterdir(): if subdir.is_dir() and "card" not in subdir.name.lower(): # Check if it contains .zst files that might be deck data zst_files = list(subdir.rglob("*.zst")) if zst_files: # Quick check: sample one file to see if it's deck data try: import subprocess result = subprocess.run( ["zstd", "-d", "-c", str(zst_files[0])], capture_output=True, text=True, timeout=2, ) if result.returncode == 0 and ("partitions" in result.stdout or "collection" in result.stdout.lower()): return export_decks_from_raw(subdir, output_path, "pokemon", max_decks) except Exception: continue print(f"Error: No Pokemon deck data found in raw directories") print(f" Note: Raw data contains cards, not decks. Need to run scraper first.") print(f" See scripts/collect_missing_decks.md for instructions") return 0 def export_yugioh_decks(output_path: Path, max_decks: int | None = None) -> int: """Export Yu-Gi-Oh decks from raw data.""" # Try multiple possible locations for deck collections (not cards) possible_dirs = [ Path("data/raw/data-sample/games/games/yugioh"), Path("data/raw/data-full/games/yugioh"), Path("data/raw/games/yugioh"), ] # Look for collection/deck directories (not card directories) for raw_dir in possible_dirs: if raw_dir.exists(): # Look for deck/collection directories (skip 'cards' directories) for subdir in raw_dir.iterdir(): if subdir.is_dir() and "card" not in subdir.name.lower(): # Check if it contains .zst files that might be deck data zst_files = list(subdir.rglob("*.zst")) if zst_files: # Quick check: sample one file to see if it's deck data try: import subprocess result = subprocess.run( ["zstd", "-d", "-c", str(zst_files[0])], capture_output=True, text=True, timeout=2, ) if result.returncode == 0 and ("partitions" in result.stdout or "collection" in result.stdout.lower()): return export_decks_from_raw(subdir, output_path, "yugioh", max_decks) except Exception: continue print(f"Error: No Yu-Gi-Oh deck data found in raw directories") print(f" Note: Raw data contains cards, not decks. Need to run scraper first.") print(f" See scripts/collect_missing_decks.md for instructions") return 0 def main() -> int: """Export missing deck datasets.""" parser = argparse.ArgumentParser(description="Export missing deck datasets") parser.add_argument("--game", choices=["pokemon", "yugioh", "all"], default="all", help="Game to export") parser.add_argument("--max-decks", type=int, help="Maximum number of decks to export") parser.add_argument("--output-dir", type=Path, default=Path("data/processed"), help="Output directory") args = parser.parse_args() output_dir = args.output_dir output_dir.mkdir(parents=True, exist_ok=True) total_exported = 0 if args.game in ["pokemon", "all"]: pokemon_output = output_dir / "decks_pokemon.jsonl" if pokemon_output.exists(): # Check if empty with open(pokemon_output) as f: count = sum(1 for _ in f) if count == 0: print(f"Warning: {pokemon_output} exists but is empty, will overwrite") else: print(f"Warning: {pokemon_output} already has {count} decks, skipping") print(f" Use --force to overwrite (not implemented)") else: exported = export_pokemon_decks(pokemon_output, args.max_decks) total_exported += exported if args.game in ["yugioh", "all"]: yugioh_output = Path("data/decks/yugioh_decks.jsonl") yugioh_output.parent.mkdir(parents=True, exist_ok=True) # Check current count if yugioh_output.exists(): with open(yugioh_output) as f: current_count = sum(1 for _ in f) if current_count < 100: print(f"Warning: {yugioh_output} has only {current_count} decks, attempting to expand...") # For now, just note it needs expansion print(f" Current: {current_count} decks (target: 1000+)") else: print(f"âœ“ {yugioh_output} already has {current_count} decks") else: exported = export_yugioh_decks(yugioh_output, args.max_decks) total_exported += exported if total_exported == 0: print("\nWarning: No decks exported. Possible reasons:") print(" - Raw data not found in expected locations") print(" - Need to run scraper first") print(" - Export tool not available") return 1 print(f"\n Total decks exported: {total_exported}") return 0 if __name__ == "__main__": sys.exit(main())
