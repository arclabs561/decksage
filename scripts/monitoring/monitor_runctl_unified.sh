#!/bin/bash # Unified monitoring for runctl training jobs with structured log parsing # Combines S3 output monitoring with live log parsing set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)" RUNCTL_BIN="${RUNCTL_BIN:-$PROJECT_ROOT/../runctl/target/release/runctl}" INSTANCE_ID="${1:-}" CHECK_INTERVAL="${CHECK_INTERVAL:-30}" USE_STRUCTURED="${USE_STRUCTURED:-1}" if [ -z "$INSTANCE_ID" ]; then echo "Usage: $0 <instance-id> [check-interval]" echo "" echo "Monitors runctl training job with:" echo " - Structured log parsing ([PROGRESS], [CHECKPOINT], etc.)" echo " - S3 output monitoring" echo " - Correlation ID tracking" exit 1 fi echo "======================================================================" echo "UNIFIED RUNCTL MONITORING - STRUCTURED LOGS + S3" echo "======================================================================" echo "Instance: $INSTANCE_ID" echo "Check interval: ${CHECK_INTERVAL}s" echo "Structured logs: $([ "$USE_STRUCTURED" = "1" ] && echo "enabled" || echo "disabled")" echo "" # Check if Python monitoring script is available MONITOR_SCRIPT="$PROJECT_ROOT/scripts/monitor_training_unified.py" if [ -f "$MONITOR_SCRIPT" ] && [ "$USE_STRUCTURED" = "1" ]; then echo "Using structured log monitoring..." echo "" python3 "$MONITOR_SCRIPT" \ --instance-id "$INSTANCE_ID" \ --interval "$CHECK_INTERVAL" \ "$([ "${2:-}" = "--once" ] && echo "--once" || true)" exit $? fi # Fallback to S3-only monitoring echo "Falling back to S3-only monitoring..." echo "" GNN_OUTPUT="s3://games-collections/embeddings/gnn_graphsage.json" EVAL_OUTPUT="s3://games-collections/experiments/hybrid_evaluation_results.json" PROGRESS_DIR="s3://games-collections/training_progress" iteration=0 gnn_found=false eval_found=false while true; do iteration=$((iteration + 1)) timestamp=$(date '+%Y-%m-%d %H:%M:%S') echo "[$iteration] $timestamp" echo "----------------------------------------------------------------------" # Check instance status using runctl if "$RUNCTL_BIN" aws processes "$INSTANCE_ID" > /dev/null 2>&1; then echo "✓ Instance: Accessible via runctl" # Show quick status "$RUNCTL_BIN" aws processes "$INSTANCE_ID" 2>&1 | grep -E "(cpu|mem|SYSTEM)" | head -3 || true else echo "✗ Instance: Not accessible (may be stopped or terminated)" fi # Check S3 outputs if aws s3 ls "$GNN_OUTPUT" > /dev/null 2>&1; then if [ "$gnn_found" = false ]; then echo " GNN embeddings: Found in S3" gnn_found=true fi else echo "⏳ GNN embeddings: Not found in S3" fi if aws s3 ls "$EVAL_OUTPUT" > /dev/null 2>&1; then if [ "$eval_found" = false ]; then echo " Evaluation results: Found in S3" eval_found=true fi else echo "⏳ Evaluation results: Not found in S3" fi # Check progress files if aws s3 ls "${PROGRESS_DIR}/training_progress.json" > /dev/null 2>&1; then echo "✓ Progress file: Available" aws s3 cp "${PROGRESS_DIR}/training_progress.json" /tmp/training_progress.json > /dev/null 2>&1 if [ -f /tmp/training_progress.json ]; then last_epoch=$(python3 -c "import json; d=json.load(open('/tmp/training_progress.json')); print(d.get('last_epoch', '?'))" 2>/dev/null || echo "?") elapsed=$(python3 -c "import json; d=json.load(open('/tmp/training_progress.json')); print(f\"{d.get('elapsed_seconds', 0)/3600:.1f}h\")" 2>/dev/null || echo "?") echo " Last epoch: $last_epoch, Elapsed: $elapsed" fi fi echo "" # If both found, exit if [ "$gnn_found" = true ] && [ "$eval_found" = true ]; then echo "======================================================================" echo "TRAINING COMPLETE" echo "======================================================================" echo "To stop instance: runctl aws stop $INSTANCE_ID" echo "To terminate instance: runctl aws terminate $INSTANCE_ID" exit 0 fi echo "Next check in ${CHECK_INTERVAL}s..." echo "" sleep "$CHECK_INTERVAL" done
