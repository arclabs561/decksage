#!/usr/bin/env bash # /// script # requires-python = ">=3.11" # /// set -euo pipefail # Generate LLM annotations, convert to substitution pairs, and train embeddings SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)" cd "$PROJECT_ROOT" echo "==========================================" echo "Step 1: Generate LLM Annotations" echo "==========================================" # Generate annotations (150 similarity pairs) uv run python -m src.ml.annotation.llm_annotator \ --similarity 150 \ --archetypes 5 \ --substitutions 10 \ --strategy diverse # Find the most recent similarity annotations file LATEST_ANNOTATIONS=$(find experiments/annotations_llm -name "similarity_annotations_*.jsonl" -type f -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -d' ' -f2-) if [ -z "$LATEST_ANNOTATIONS" ] || [ ! -f "$LATEST_ANNOTATIONS" ]; then echo "Error: Error: Could not find generated annotations" exit 1 fi echo "" echo " Found annotations: $LATEST_ANNOTATIONS" echo "" echo "==========================================" echo "Step 2: Convert to Substitution Pairs" echo "==========================================" SUBSTITUTION_PAIRS="experiments/substitution_pairs_from_llm.json" uv run python -m src.ml.scripts.convert_annotations_to_substitution_pairs \ --input "$LATEST_ANNOTATIONS" \ --output "$SUBSTITUTION_PAIRS" \ --min-similarity 0.8 \ --stats if [ ! -f "$SUBSTITUTION_PAIRS" ]; then echo "Error: Error: Failed to create substitution pairs" exit 1 fi echo "" echo " Created substitution pairs: $SUBSTITUTION_PAIRS" echo "" echo "==========================================" echo "Step 3: Train Embeddings with Annotations" echo "==========================================" OUTPUT_EMBEDDING="data/embeddings/multitask_with_llm_annotations.wv" # Use graph database if available, otherwise pairs CSV if [ -f "data/graphs/incremental_graph.db" ]; then echo "Using graph database..." uv run python -m src.ml.scripts.train_multitask_refined_enhanced \ --graph-db data/graphs/incremental_graph.db \ --substitution-pairs "$SUBSTITUTION_PAIRS" \ --substitution-weight 5.0 \ --output "$OUTPUT_EMBEDDING" else echo "Using pairs CSV..." uv run python -m src.ml.scripts.train_multitask_refined_enhanced \ --pairs data/processed/pairs_large.csv \ --substitution-pairs "$SUBSTITUTION_PAIRS" \ --substitution-weight 5.0 \ --output "$OUTPUT_EMBEDDING" fi echo "" echo " Training complete!" echo " Embeddings saved to: $OUTPUT_EMBEDDING" echo "" echo "Next: Evaluate the new embeddings and compare with baseline"