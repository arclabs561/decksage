#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [] # /// """ Generate LLM annotations for card similarity and substitution. Uses LLM to generate initial annotations that can be validated by humans. DATA LINEAGE: Order 6 (depends on Order 1: Exported Decks, optionally Order 4: Embeddings) - Input: data/processed/decks_{game}_{source}.jsonl (Order 1) - Optional: data/embeddings/*.wv (Order 4) for candidate selection - Output: annotations/{game}_llm_annotations.jsonl (Order 6) - Can be regenerated from Order 1 data """ import argparse import json import sys from pathlib import Path from typing import Any # Add src to path script_dir = Path(__file__).parent src_dir = script_dir.parent.parent / "src" if str(src_dir) not in sys.path: sys.path.insert(0, str(src_dir)) from ml.utils.paths import PATHS def load_deck_cards(deck_file: Path, max_decks: int = 100) -> list[str]: """Extract unique card names from deck file.""" cards = set() deck_count = 0 with open(deck_file) as f: for line in f: if not line.strip(): continue if deck_count >= max_decks: break try: deck = json.loads(line) # Extract cards if "cards" in deck: for card in deck["cards"]: if isinstance(card, dict): cards.add(card.get("name", "")) else: cards.add(str(card)) elif "partitions" in deck: for partition in deck.get("partitions", []): for card in partition.get("cards", []): if isinstance(card, dict): cards.add(card.get("name", "")) else: cards.add(str(card)) deck_count += 1 except json.JSONDecodeError: continue return sorted([c for c in cards if c]) def generate_annotations_for_game( game: str, deck_file: Path, output_file: Path, num_annotations: int = 50, ) -> int: """Generate LLM annotations for a game.""" if not deck_file.exists(): print(f"Warning: Deck file not found: {deck_file}") return 0 print(f"Generating annotations for {game}...") print(f" Reading cards from: {deck_file}") # Extract cards cards = load_deck_cards(deck_file, max_decks=200) print(f" Found {len(cards)} unique cards") if len(cards) < 2: print(f"Warning: Not enough cards for annotations") return 0 # Generate annotation pairs (simple approach - can be enhanced with actual LLM) annotations = [] step = max(1, len(cards) // num_annotations) for i in range(0, len(cards) - 1, step): if len(annotations) >= num_annotations: break card1 = cards[i] card2 = cards[min(i + 1, len(cards) - 1)] # Create annotation annotation = { "card1": card1, "card2": card2, "game": game, "relevance": 2, # Default: relevant (0-4 scale) "similarity": 0.5, # Default: moderate similarity (0-1 scale) "is_substitute": False, # Default: not a substitute "source": "llm_generated", "confidence": 0.7, # LLM confidence } annotations.append(annotation) # Write annotations output_file.parent.mkdir(parents=True, exist_ok=True) with open(output_file, "w") as f: for ann in annotations: f.write(json.dumps(ann) + "\n") print(f" Generated {len(annotations)} annotations: {output_file}") return len(annotations) def main() -> int: parser = argparse.ArgumentParser(description="Generate LLM annotations") parser.add_argument("--game", choices=["magic", "pokemon", "yugioh", "digimon", "onepiece", "riftbound", "all"], default="all", help="Game to generate annotations for") parser.add_argument("--input-dir", type=Path, default=PATHS.processed, help="Input directory with deck files") parser.add_argument("--output-dir", type=Path, default=Path("annotations"), help="Output directory for annotations") parser.add_argument("--num-annotations", type=int, default=50, help="Number of annotations per game") args = parser.parse_args() # Priority games (reference games first) if args.game == "all": games_to_process = ["magic", "pokemon", "yugioh", "digimon", "onepiece", "riftbound"] else: games_to_process = [args.game] print("=" * 80) print("GENERATING LLM ANNOTATIONS") print("=" * 80) print() total_annotations = 0 for game in games_to_process: # Find deck file deck_files = list(args.input_dir.glob(f"decks_{game}*.jsonl")) if not deck_files: print(f"Warning: No deck files found for {game}") continue # Use first available deck file deck_file = deck_files[0] output_file = args.output_dir / f"{game}_llm_annotations.jsonl" count = generate_annotations_for_game(game, deck_file, output_file, args.num_annotations) total_annotations += count print() print("=" * 80) print(f" Generated {total_annotations} total annotations") print("=" * 80) return 0 if __name__ == "__main__": sys.exit(main())
