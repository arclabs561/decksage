#!/usr/bin/env bash # /// script # requires-python = ">=3.11" # /// set -euo pipefail # Combine multiple annotation sources and train embeddings SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)" cd "$PROJECT_ROOT" echo "==========================================" echo "Combining Annotations and Training" echo "==========================================" # Find all annotation sources HAND_ANNOTATIONS="annotations/batch_001_initial.yaml" LLM_ANNOTATIONS=$(find experiments/annotations_llm -name "similarity_annotations_*.jsonl" -type f 2>/dev/null | sort -t_ -k2 -r | head -1) COMBINED_PAIRS="experiments/substitution_pairs_combined.json" echo "" echo "Annotation sources:" echo " Hand: $HAND_ANNOTATIONS" if [ -n "$LLM_ANNOTATIONS" ] && [ -f "$LLM_ANNOTATIONS" ]; then echo " LLM: $LLM_ANNOTATIONS" else echo " LLM: (not ready yet)" fi echo "" # Convert hand annotations echo "Step 1: Converting hand annotations..." HAND_PAIRS="experiments/substitution_pairs_hand.json" uv run python -m src.ml.scripts.convert_annotations_to_substitution_pairs \ --input "$HAND_ANNOTATIONS" \ --output "$HAND_PAIRS" \ --min-relevance 4 # Convert LLM annotations if available if [ -n "$LLM_ANNOTATIONS" ] && [ -f "$LLM_ANNOTATIONS" ]; then echo "" echo "Step 2: Converting LLM annotations..." LLM_PAIRS="experiments/substitution_pairs_llm.json" uv run python -m src.ml.scripts.convert_annotations_to_substitution_pairs \ --input "$LLM_ANNOTATIONS" \ --output "$LLM_PAIRS" \ --min-similarity 0.8 # Combine pairs echo "" echo "Step 3: Combining annotation sources..." uv run python -c " import json from pathlib import Path hand_pairs = json.load(open('$HAND_PAIRS')) llm_pairs = json.load(open('$LLM_PAIRS')) # Combine and deduplicate all_pairs = {} for pair in hand_pairs + llm_pairs: key = tuple(sorted(pair)) all_pairs[key] = pair combined = [list(pair) for pair in all_pairs.values()] print(f'Hand pairs: {len(hand_pairs)}') print(f'LLM pairs: {len(llm_pairs)}') print(f'Combined (deduplicated): {len(combined)}') json.dump(combined, open('$COMBINED_PAIRS', 'w'), indent=2) " else echo "" echo "Step 2: LLM annotations not ready, using hand annotations only" cp "$HAND_PAIRS" "$COMBINED_PAIRS" fi echo "" echo "Step 4: Training with combined annotations..." OUTPUT_EMBEDDING="data/embeddings/multitask_with_combined_annotations.wv" if [ -f "data/graphs/incremental_graph.db" ]; then uv run python -m src.ml.scripts.train_multitask_refined_enhanced \ --graph-db data/graphs/incremental_graph.db \ --substitution-pairs "$COMBINED_PAIRS" \ --substitution-weight 5.0 \ --output "$OUTPUT_EMBEDDING" \ --epochs 10 else uv run python -m src.ml.scripts.train_multitask_refined_enhanced \ --pairs data/processed/pairs_large.csv \ --substitution-pairs "$COMBINED_PAIRS" \ --substitution-weight 5.0 \ --output "$OUTPUT_EMBEDDING" \ --epochs 10 fi echo "" echo " Complete!" echo " Embeddings: $OUTPUT_EMBEDDING" echo " Substitution pairs: $COMBINED_PAIRS"
