#!/bin/bash # Evaluate hybrid embedding system using runctl # Usage: ./scripts/evaluation/eval_hybrid_with_runctl.sh [local|aws] [instance-id] [options...] set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)" RUNCTL_BIN="${RUNCTL_BIN:-$PROJECT_ROOT/../runctl/target/release/runctl}" MODE="${1:-local}" shift || true # Default arguments TEST_SET="${TEST_SET:-experiments/test_set_canonical_magic.json}" GRAPH_PATH="${GRAPH_PATH:-data/graphs/incremental_graph.json}" GNN_MODEL="${GNN_MODEL:-data/embeddings/gnn_graphsage.json}" COOCCURRENCE="${COOCCURRENCE:-data/embeddings/production.wv}" INSTRUCTION_MODEL="${INSTRUCTION_MODEL:-intfloat/e5-base-v2}" OUTPUT="${OUTPUT:-experiments/hybrid_evaluation_results.json}" USE_TEMPORAL_SPLIT="${USE_TEMPORAL_SPLIT:-true}" OUTPUT_VERSION="${OUTPUT_VERSION:-}" # Find or build runctl if [[ ! -f "$RUNCTL_BIN" ]]; then if [[ -d "$PROJECT_ROOT/../runctl" ]]; then echo "Warning: runctl not found, building..." (cd "$PROJECT_ROOT/../runctl" && cargo build --release) || { echo "Error: Failed to build runctl" exit 1 } else echo "Error: runctl not found at $RUNCTL_BIN" exit 1 fi fi echo " Evaluating hybrid embeddings with runctl (mode: $MODE)" echo " Test set: $TEST_SET" echo " Output: $OUTPUT" echo "" if [[ "$MODE" == "local" ]]; then # Local evaluation COMMON_ARGS=( "--test-set" "$TEST_SET" "--graph" "$GRAPH_PATH" "--gnn-model" "$GNN_MODEL" "--cooccurrence-embeddings" "$COOCCURRENCE" "--instruction-model" "$INSTRUCTION_MODEL" "--output" "$OUTPUT" ) if [[ "$USE_TEMPORAL_SPLIT" == "true" ]]; then COMMON_ARGS+=("--use-temporal-split") else COMMON_ARGS+=("--no-temporal-split") fi if [[ -n "$OUTPUT_VERSION" ]]; then COMMON_ARGS+=("--output-version" "$OUTPUT_VERSION") fi "$RUNCTL_BIN" local "src/ml/scripts/evaluate_hybrid_with_runctl.py" -- \ "${COMMON_ARGS[@]}" \ "$@" elif [[ "$MODE" == "aws" ]]; then # AWS evaluation if [[ $# -lt 1 ]]; then echo "Error: AWS mode requires instance ID" exit 1 fi INSTANCE_ID="$1" shift || true # Use S3 paths if [[ "$TEST_SET" != s3://* ]]; then TEST_SET_S3="s3://games-collections/experiments/test_set_canonical_magic.json" else TEST_SET_S3="$TEST_SET" fi if [[ "$GNN_MODEL" != s3://* ]]; then GNN_MODEL_S3="s3://games-collections/embeddings/gnn_graphsage.json" else GNN_MODEL_S3="$GNN_MODEL" fi if [[ "$GRAPH_PATH" != s3://* ]]; then GRAPH_S3="s3://games-collections/graphs/incremental_graph.json" else GRAPH_S3="$GRAPH_PATH" fi if [[ "$COOCCURRENCE" != s3://* ]]; then COOCCURRENCE_S3="s3://games-collections/embeddings/production.wv" else COOCCURRENCE_S3="$COOCCURRENCE" fi if [[ "$OUTPUT" != s3://* ]]; then OUTPUT_S3="s3://games-collections/experiments/hybrid_evaluation_results.json" else OUTPUT_S3="$OUTPUT" fi # Build Python arguments PYTHON_ARGS=( "--test-set" "$(basename "$TEST_SET")" "--graph" "$(basename "$GRAPH_PATH")" "--gnn-model" "$(basename "$GNN_MODEL")" "--cooccurrence-embeddings" "$(basename "$COOCCURRENCE")" "--instruction-model" "$INSTRUCTION_MODEL" "--output" "$(basename "$OUTPUT")" ) if [[ "$USE_TEMPORAL_SPLIT" == "true" ]]; then PYTHON_ARGS+=("--use-temporal-split") else PYTHON_ARGS+=("--no-temporal-split") fi # Per cursor rules: Use --data-s3 and --output-s3 for cloud evaluation # Show all progress (no tail/head piping) PYTHON_ARGS=( "--test-set" "$TEST_SET" "--graph" "$GRAPH_PATH" "--gnn-model" "$GNN_MODEL" "--cooccurrence-embeddings" "$COOCCURRENCE" "--instruction-model" "$INSTRUCTION_MODEL" "--output" "$OUTPUT" ) if [[ "$USE_TEMPORAL_SPLIT" == "true" ]]; then PYTHON_ARGS+=("--use-temporal-split") else PYTHON_ARGS+=("--no-temporal-split") fi if [[ -n "$OUTPUT_VERSION" ]]; then PYTHON_ARGS+=("--output-version" "$OUTPUT_VERSION") fi "$RUNCTL_BIN" aws train "$INSTANCE_ID" \ "src/ml/scripts/evaluate_hybrid_with_runctl.py" \ --data-s3 "$TEST_SET_S3" \ --data-s3 "$GRAPH_S3" \ --data-s3 "$GNN_MODEL_S3" \ --data-s3 "$COOCCURRENCE_S3" \ --output-s3 "$OUTPUT_S3" \ -- \ "${PYTHON_ARGS[@]}" \ "$@" else echo "Error: Unknown mode: $MODE" exit 1 fi echo " Evaluation complete"
