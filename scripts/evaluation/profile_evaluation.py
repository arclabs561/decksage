#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # /// """ Profile evaluation code to identify performance bottlenecks. Usage: uv run python scripts/evaluation/profile_evaluation.py """ import cProfile import pstats import io from pathlib import Path import sys # Add project root to path project_root = Path(__file__).parent.parent.parent sys.path.insert(0, str(project_root)) sys.path.insert(0, str(project_root / "src")) def profile_evaluation(): """Profile the evaluation code.""" from ml.similarity.fusion import WeightedLateFusion, FusionWeights from ml.similarity.similarity_methods import load_graph from gensim.models import KeyedVectors # Load minimal test data print("Loading test data...") embeddings_path = Path("data/embeddings/game_specific/magic_128d_test_pecanpy.wv") if not embeddings_path.exists(): print(f"Error: Embeddings not found: {embeddings_path}") return # Profile embedding loading print("\n1. Profiling embedding loading...") profiler = cProfile.Profile() profiler.enable() embeddings = KeyedVectors.load(str(embeddings_path)) profiler.disable() s = io.StringIO() ps = pstats.Stats(profiler, stream=s) ps.sort_stats('cumulative') ps.print_stats(10) print(s.getvalue()) # Profile graph loading print("\n2. Profiling graph loading (SQLite)...") graph_db = Path("data/graphs/incremental_graph.db") if graph_db.exists(): profiler = cProfile.Profile() profiler.enable() try: from ml.utils.shared_operations import load_graph_for_jaccard adj = load_graph_for_jaccard(graph_db=graph_db, game="MTG") except Exception as e: print(f"Error loading graph: {e}") adj = {} profiler.disable() s = io.StringIO() ps = pstats.Stats(profiler, stream=s) ps.sort_stats('cumulative') ps.print_stats(20) print(s.getvalue()) # Profile graph loading (CSV fallback) print("\n3. Profiling graph loading (CSV)...") pairs_csv = Path("data/processed/pairs_large.csv") if pairs_csv.exists(): profiler = cProfile.Profile() profiler.enable() try: from ml.utils.shared_operations import load_graph_for_jaccard adj = load_graph_for_jaccard(pairs_csv=pairs_csv, game="MTG") except Exception as e: print(f"Error loading graph from CSV: {e}") adj = {} profiler.disable() s = io.StringIO() ps = pstats.Stats(profiler, stream=s) ps.sort_stats('cumulative') ps.print_stats(20) print(s.getvalue()) # Profile fusion similarity query print("\n4. Profiling fusion similarity query...") if embeddings and adj: fusion = WeightedLateFusion( embeddings=embeddings, adj=adj, weights=FusionWeights(), ) # Test query test_card = "Lightning Bolt" if test_card in embeddings or test_card in adj: profiler = cProfile.Profile() profiler.enable() for _ in range(10): # Run 10 queries results = fusion.similar(test_card, k=20, task_type="substitution") profiler.disable() s = io.StringIO() ps = pstats.Stats(profiler, stream=s) ps.sort_stats('cumulative') ps.print_stats(30) print(s.getvalue()) print("\n Profiling complete!") if __name__ == "__main__": profile_evaluation()
