#!/usr/bin/env bash # Profile and optimize evaluation code # # Usage: # ./scripts/evaluation/optimize_and_profile.sh set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)" cd "$PROJECT_ROOT" echo "═══════════════════════════════════════════════════════════════════════" echo "PROFILING AND OPTIMIZING EVALUATION CODE" echo "═══════════════════════════════════════════════════════════════════════" echo "" # Step 1: Profile the code echo "STEP 1: Profiling evaluation code..." echo "" uv run python scripts/evaluation/profile_evaluation.py > experiments/profile_results.txt 2>&1 echo " Profiling complete. Results saved to: experiments/profile_results.txt" echo "" # Step 2: Run quick evaluation to measure improvements echo "STEP 2: Running quick evaluation to measure performance..." echo "" QUICK_TEST="experiments/test_substitutions_quick.json" if [ ! -f "$QUICK_TEST" ]; then echo "Creating quick test set..." python3 -c " import json from pathlib import Path test_set = Path('experiments/test_set_unified_magic.json') with open(test_set) as f: data = json.load(f) queries = data.get('queries', {}) pairs = [] for query_card, labels in list(queries.items())[:50]: if isinstance(labels, dict): highly_relevant = labels.get('highly_relevant', []) relevant = labels.get('relevant', []) for target in (highly_relevant + relevant)[:1]: if target and query_card: pairs.append([query_card, target]) if len(pairs) >= 50: break if len(pairs) >= 50: break with open('$QUICK_TEST', 'w') as f: json.dump(pairs, f, indent=2) print(f'Created {len(pairs)} test pairs') " fi echo "Running optimized evaluation..." time uv run python src/ml/scripts/evaluate_downstream_complete.py \ --game magic \ --embeddings data/embeddings/game_specific/magic_128d_test_pecanpy.wv \ --pairs data/processed/pairs_large.csv \ --test-substitutions "$QUICK_TEST" \ --output experiments/downstream_eval_optimized.json 2>&1 | tee /tmp/optimized_eval.log echo "" echo " Optimization test complete!" echo "" echo "Check results:" echo " - Profile: experiments/profile_results.txt" echo " - Evaluation: experiments/downstream_eval_optimized.json" echo " - Log: /tmp/optimized_eval.log"
