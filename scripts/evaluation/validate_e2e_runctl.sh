#!/usr/bin/env bash # End-to-end validation of evaluation on runctl AWS # Usage: ./scripts/evaluation/validate_e2e_runctl.sh [--game magic] [--quick] set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)" RUNCTL="${PROJECT_ROOT}/../runctl/target/release/runctl" # Check runctl exists if [ ! -f "$RUNCTL" ]; then echo "Error: runctl not found at $RUNCTL" echo "Build it with: cd ../runctl && cargo build --release" exit 1 fi # Default arguments GAME="${1:-magic}" QUICK="${2:-}" if [ "$QUICK" == "--quick" ]; then TEST_SUBSTITUTIONS="experiments/test_substitutions_quick.json" OUTPUT_VERSION="quick_test" else TEST_SUBSTITUTIONS="experiments/test_set_unified_${GAME}.json" OUTPUT_VERSION="full_eval" fi EMBEDDINGS_PATH="data/embeddings/game_specific/${GAME}_128d_test_pecanpy.wv" OUTPUT_DIR="experiments/downstream_eval_${GAME}_${OUTPUT_VERSION}_runctl" DATA_S3="${DATA_S3:-s3://games-collections/}" OUTPUT_S3="${OUTPUT_S3:-s3://games-collections/experiments/}" echo "═══════════════════════════════════════════════════════════════════════" echo "E2E VALIDATION: EVALUATION ON RUNCTL AWS" echo "═══════════════════════════════════════════════════════════════════════" echo "" echo "Game: $GAME" echo "Test set: $TEST_SUBSTITUTIONS" echo "Output: $OUTPUT_DIR" echo "" # Step 1: Create or use existing instance echo "STEP 1: Setting up AWS instance..." INSTANCE_ID="${INSTANCE_ID:-}" if [ -z "$INSTANCE_ID" ]; then echo "Creating new instance..." INSTANCE_TYPE="g5.xlarge" CREATE_OUTPUT=$("$RUNCTL" aws create \ --spot \ --key-name tarek \ --iam-instance-profile EC2-SSM-InstanceProfile \ --data-volume-size 100 \ "$INSTANCE_TYPE" 2>&1) || CREATE_OUTPUT=$("$RUNCTL" aws create \ --key-name tarek \ --iam-instance-profile EC2-SSM-InstanceProfile \ --data-volume-size 100 \ "$INSTANCE_TYPE" 2>&1) echo "$CREATE_OUTPUT" INSTANCE_ID=$(echo "$CREATE_OUTPUT" | grep -oE 'i-[a-z0-9]{17}' | head -1 || echo "") if [ -z "$INSTANCE_ID" ]; then echo "Error: Failed to create instance" exit 1 fi echo " Created instance: $INSTANCE_ID" echo "Waiting for instance to be ready..." sleep 60 # Give instance time to initialize and mount EBS else echo "Using existing instance: $INSTANCE_ID" fi # Step 2: Pre-warm EBS volume (if needed) echo "" echo "STEP 2: Checking EBS volume..." echo "Note: EBS volume should be pre-warmed with data for faster execution" echo "Run: ./scripts/evaluation/pre_warm_ebs_volume.sh $INSTANCE_ID" echo "" # Step 3: Run evaluation echo "STEP 3: Running evaluation on AWS..." echo "" PROJECT_NAME=$(basename "$PROJECT_ROOT") export TRAINCTL_USE_SHELL_SYNC=1 EVAL_ARGS=( --game "$GAME" --embeddings "$EMBEDDINGS_PATH" --output "$OUTPUT_DIR/results.json" --test-substitutions "$TEST_SUBSTITUTIONS" --pairs "data/processed/pairs_large.csv" --fast --use-runctl ) "$RUNCTL" aws train "$INSTANCE_ID" \ "src/ml/scripts/evaluate_downstream_complete.py" \ --data-s3 "$DATA_S3" \ --output-s3 "$OUTPUT_S3" \ --project-name "$PROJECT_NAME" \ -- \ "${EVAL_ARGS[@]}" echo "" echo "═══════════════════════════════════════════════════════════════════════" echo " EVALUATION JOB SUBMITTED" echo "═══════════════════════════════════════════════════════════════════════" echo "" echo "Instance: $INSTANCE_ID" echo "Monitor with:" echo " $RUNCTL aws monitor $INSTANCE_ID" echo "" echo "Or check S3:" echo " aws s3 ls ${OUTPUT_S3}downstream_eval_${GAME}_${OUTPUT_VERSION}_runctl/" echo "" echo "Or SSH and check logs:" echo " ssh -i ~/.ssh/tarek.pem ec2-user@<instance-ip> 'tail -f /home/ec2-user/decksage/training.log'" echo ""
