#!/bin/bash # Create IAM role and instance profile for EC2 SSM access ROLE_NAME="EC2-SSM-Access-Role" PROFILE_NAME="EC2-SSM-InstanceProfile" echo "Creating IAM role for SSM access..." # Create role aws iam create-role \ --role-name $ROLE_NAME \ --assume-role-policy-document '{ "Version": "2012-10-17", "Statement": [ { "Effect": "Allow", "Principal": { "Service": "ec2.amazonaws.com" }, "Action": "sts:AssumeRole" } ] }' 2>&1 | grep -v "EntityAlreadyExists" || echo "Role already exists" # Attach SSM managed policy aws iam attach-role-policy \ --role-name $ROLE_NAME \ --policy-arn arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore 2>&1 | grep -v "EntityAlreadyExists" || echo "Policy already attached" # Create instance profile aws iam create-instance-profile \ --instance-profile-name $PROFILE_NAME 2>&1 | grep -v "EntityAlreadyExists" || echo "Instance profile already exists" # Add role to instance profile aws iam add-role-to-instance-profile \ --instance-profile-name $PROFILE_NAME \ --role-name $ROLE_NAME 2>&1 | grep -v "EntityAlreadyExists" || echo "Role already in profile" echo "" echo " IAM role and instance profile created:" echo " Role: $ROLE_NAME" echo " Instance Profile: $PROFILE_NAME" echo "" echo "Note: It may take a few seconds for the instance profile to be available."set -euo pipefail
