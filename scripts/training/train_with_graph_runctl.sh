#!/usr/bin/env bash # Train co-occurrence embeddings using graph (not pairs CSV) via runctl on AWS set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)" RUNCTL="${PROJECT_ROOT}/../runctl/target/release/runctl" # Check runctl exists if [ ! -f "$RUNCTL" ]; then echo "Error: runctl not found at $RUNCTL" echo "Build it with: cd ../runctl && cargo build --release" exit 1 fi # Configuration OUTPUT_VERSION="${OUTPUT_VERSION:-v2024-W01}" EPOCHS="${EPOCHS:-20}" DIM="${DIM:-128}" # S3 paths DATA_S3="${DATA_S3:-s3://games-collections/}" OUTPUT_S3="${OUTPUT_S3:-s3://games-collections/experiments/}" # Graph path (use graph, not pairs!) GRAPH_DB="${GRAPH_DB:-s3://games-collections/graphs/incremental_graph.db}" DECKS_JSONL="${DECKS_JSONL:-s3://games-collections/processed/decks_all_final.jsonl}" # Output path OUTPUT_PATH="data/embeddings/multitask_enhanced_graph_${OUTPUT_VERSION}.wv" echo "==========================================" echo "Training with Graph (not pairs CSV)" echo "==========================================" echo "Graph: $GRAPH_DB" echo "Decks: $DECKS_JSONL" echo "Output version: $OUTPUT_VERSION" echo "Epochs: $EPOCHS" echo "Dimensions: $DIM" echo "Output: $OUTPUT_PATH" echo "" # Create instance first, then train # Use SSH instead of SSM to avoid S3 bucket requirement # Try spot first, fallback to on-demand if spot fails echo "Creating AWS instance with EBS volume..." CREATE_OUTPUT=$("$RUNCTL" aws create \ --key-name tarek \ --data-volume-size 500 \ g5.2xlarge 2>&1) || CREATE_OUTPUT=$("$RUNCTL" aws create \ --key-name tarek \ --data-volume-size 500 \ g5.2xlarge 2>&1) echo "$CREATE_OUTPUT" # Extract instance ID (look for "Created" or "instance:" pattern) INSTANCE_ID=$(echo "$CREATE_OUTPUT" | grep -iE '(created|instance:).*i-[a-z0-9]+' | grep -oE 'i-[a-z0-9]+' | head -1 || echo "") # Fallback: just get any i-* pattern (17 chars after i-) if [ -z "$INSTANCE_ID" ]; then INSTANCE_ID=$(echo "$CREATE_OUTPUT" | grep -oE 'i-[a-z0-9]{17}' | head -1 || echo "") fi if [ -z "$INSTANCE_ID" ]; then echo "Error: Failed to create instance or extract instance ID" echo "Full output:" echo "$CREATE_OUTPUT" exit 1 fi echo " Created instance: $INSTANCE_ID" echo "Waiting for instance to be ready..." sleep 45 # Give instance time to initialize # Train on the instance # Note: Using --graph-db instead of --pairs (this is the key change!) echo "Submitting training job (using graph, not pairs CSV)..." "$RUNCTL" aws train "$INSTANCE_ID" \ "src/ml/scripts/train_multitask_refined_enhanced.py" \ --data-s3 "$DATA_S3" \ --output-s3 "$OUTPUT_S3" \ -- \ --graph-db "$GRAPH_DB" \ --decks "$DECKS_JSONL" \ --output "$OUTPUT_PATH" \ --output-version "$OUTPUT_VERSION" \ --dim "$DIM" \ --epochs "$EPOCHS" \ --walk-length 80 \ --num-walks 10 \ --window-size 10 \ --cooccurrence-weight 1.0 \ --substitution-weight 5.0 \ --min-cooccurrence 1 \ --checkpoint-interval 5 \ --progress-dir "data/embeddings/training_progress_graph_${OUTPUT_VERSION}" echo "" echo "Training started on instance: $INSTANCE_ID" echo "Using graph database: $GRAPH_DB (not pairs CSV!)" echo "The instance will auto-stop when training completes" echo "" echo " Training job submitted (using graph, not pairs CSV)!" echo "Instance: $INSTANCE_ID" echo "Monitor with: $RUNCTL aws monitor $INSTANCE_ID"