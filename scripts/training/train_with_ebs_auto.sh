#!/bin/bash # Automated training with EBS code detection # Uses runctl as intended, with automatic EBS code detection set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)" RUNCTL_BIN="${RUNCTL_BIN:-$PROJECT_ROOT/../runctl/target/release/runctl}" INSTANCE_ID="${1:-}" if [[ -z "$INSTANCE_ID" ]]; then echo "Usage: $0 <instance-id> [script-args...]" exit 1 fi shift || true # Extract --output-version from remaining args if present OUTPUT_VERSION="" REMAINING_ARGS=() while [[ $# -gt 0 ]]; do case $1 in --output-version) OUTPUT_VERSION="$2" shift 2 ;; *) REMAINING_ARGS+=("$1") shift ;; esac done set -- "${REMAINING_ARGS[@]}" # Find or build runctl if [[ ! -f "$RUNCTL_BIN" ]]; then if [[ -d "$PROJECT_ROOT/../runctl" ]]; then echo "Building runctl..." (cd "$PROJECT_ROOT/../runctl" && cargo build --release) || exit 1 else echo "Error: runctl not found" exit 1 fi fi # Check if code exists on EBS (fast path) echo "Checking for code on EBS volumes..." CODE_ON_EBS=false EBS_PATH="" for path in "/mnt/data500/code" "/mnt/data/code" "/data/code"; do if aws ssm send-command \ --instance-ids "$INSTANCE_ID" \ --document-name "AWS-RunShellScript" \ --parameters "commands=[\"test -f $path/src/ml/scripts/train_hybrid_from_pairs.py && echo EXISTS || echo NOT_FOUND\"]" \ --output text \ --query 'Command.CommandId' 2>/dev/null | xargs -I {} sh -c 'sleep 3 && aws ssm get-command-invocation --command-id {} --instance-id '"$INSTANCE_ID"' --query "StandardOutputContent" --output text 2>/dev/null | grep -q EXISTS && echo EXISTS || echo NOT_FOUND' | grep -q EXISTS; then CODE_ON_EBS=true EBS_PATH="$path" echo "âœ“ Code found on EBS: $EBS_PATH" break fi done # Determine script path if [[ "$CODE_ON_EBS" == "true" ]]; then SCRIPT_PATH="$EBS_PATH/src/ml/scripts/train_hybrid_from_pairs.py" SYNC_CODE="false" else SCRIPT_PATH="src/ml/scripts/train_hybrid_from_pairs.py" SYNC_CODE="true" echo "Code not on EBS, will sync via runctl" fi # Run training with runctl (as intended) echo "" echo "Starting training with runctl..." echo " Instance: $INSTANCE_ID" echo " Script: $SCRIPT_PATH" echo " Sync code: $SYNC_CODE" echo "" # Build script arguments SCRIPT_ARGS=("$@") if [[ -n "$OUTPUT_VERSION" ]]; then SCRIPT_ARGS+=("--output-version" "$OUTPUT_VERSION") fi "$RUNCTL_BIN" aws train "$INSTANCE_ID" "$SCRIPT_PATH" \ --data-s3 "s3://games-collections/" \ --output-s3 "s3://games-collections/" \ --sync-code "$SYNC_CODE" \ --auto-stop \ -- \ "${SCRIPT_ARGS[@]}" echo "" echo " Training started" echo " Monitor: runctl aws monitor $INSTANCE_ID" echo " Instance will auto-stop when training completes"
