#!/bin/bash # Train enhanced embeddings using runctl (LOCAL MODE) # This is the proper way to run enhanced training with runctl # # Usage: ./scripts/training/train_enhanced_runctl_local.sh [options...] set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)" cd "$PROJECT_ROOT" # Find or build runctl # Path: ../runctl (sibling to decksage in dev/) RUNCTL_BIN="${RUNCTL_BIN:-$PROJECT_ROOT/../runctl/target/release/runctl}" if [[ ! -f "$RUNCTL_BIN" ]]; then if [[ -d "$PROJECT_ROOT/../runctl" ]]; then echo "Building runctl..." (cd "$PROJECT_ROOT/../runctl" && cargo build --release) || { echo "Error: Failed to build runctl" exit 1 } RUNCTL_BIN="$PROJECT_ROOT/../runctl/target/release/runctl" else echo "Error: runctl not found at $RUNCTL_BIN" echo " Expected: $PROJECT_ROOT/../runctl/target/release/runctl" exit 1 fi fi echo "======================================================================" echo "ENHANCED TRAINING WITH RUNCTL (LOCAL)" echo "======================================================================" echo "Using runctl: $RUNCTL_BIN" echo "" # Default parameters (can be overridden via environment) PAIRS_CSV="${PAIRS_CSV:-data/processed/pairs_large.csv}" DECKS_JSONL="${DECKS_JSONL:-data/processed/decks_all_final.jsonl}" GRAPH_DB="${GRAPH_DB:-data/graphs/incremental_graph.db}" OUTPUT="${OUTPUT:-data/embeddings/multitask_enhanced.wv}" DIM="${DIM:-128}" EPOCHS="${EPOCHS:-5}" NUM_WALKS="${NUM_WALKS:-10}" WALK_LENGTH="${WALK_LENGTH:-80}" WINDOW_SIZE="${WINDOW_SIZE:-10}" WORKERS="${WORKERS:-4}" CHECKPOINT_INTERVAL="${CHECKPOINT_INTERVAL:-2}" PROGRESS_DIR="${PROGRESS_DIR:-data/embeddings/multitask/training_progress}" # Research-based Word2Vec parameters (2025-01-01 refinements) # These improve ranking quality (MRR) based on recent research NEGATIVE="${NEGATIVE:-5}" # Negative samples (research: 5-20 optimal for large vocabularies) SAMPLE="${SAMPLE:-0.001}" # Subsampling threshold (1e-3 typical, 1e-4 to 1e-5 range) ALPHA="${ALPHA:-0.025}" # Initial learning rate MIN_ALPHA="${MIN_ALPHA:-0.0001}" # Minimum learning rate (linear decay) BATCH_WORDS="${BATCH_WORDS:-10000}" # Batch size (research: larger batches 10K-50K improve MRR) # Determine data source (prefer graph, then decks, then pairs) DATA_ARGS=() if [[ -f "$GRAPH_DB" ]] || [[ -f "${GRAPH_DB%.db}.json" ]]; then echo "Using graph database as data source" if [[ -f "$GRAPH_DB" ]]; then DATA_ARGS=("--graph-db" "$GRAPH_DB") else DATA_ARGS=("--graph-db" "${GRAPH_DB%.db}.json") fi if [[ -f "$DECKS_JSONL" ]]; then DATA_ARGS+=("--decks" "$DECKS_JSONL") fi elif [[ -f "$DECKS_JSONL" ]]; then echo "Using decks JSONL as data source" DATA_ARGS=("--decks" "$DECKS_JSONL") elif [[ -f "$PAIRS_CSV" ]]; then echo "Using pairs CSV as data source" DATA_ARGS=("--pairs" "$PAIRS_CSV") if [[ -f "$DECKS_JSONL" ]]; then DATA_ARGS+=("--decks" "$DECKS_JSONL") fi else echo "Error: No data source found" echo " Checked: $GRAPH_DB, $DECKS_JSONL, $PAIRS_CSV" exit 1 fi echo "Data source: ${DATA_ARGS[0]} ${DATA_ARGS[1]}" echo "Output: $OUTPUT" echo "Parameters: dim=$DIM, epochs=$EPOCHS, walks=$NUM_WALKS, length=$WALK_LENGTH" echo "Workers: $WORKERS" echo "Checkpoint interval: $CHECKPOINT_INTERVAL epochs" echo "" # Run with runctl (this enables monitoring, checkpointing, etc.) echo " Starting training with runctl..." echo " Monitor with: $RUNCTL_BIN monitor" echo " Check status: $RUNCTL_BIN status" echo "" "$RUNCTL_BIN" local "src/ml/scripts/train_multitask_refined_enhanced.py" -- \ "${DATA_ARGS[@]}" \ --output "$OUTPUT" \ --dim "$DIM" \ --epochs "$EPOCHS" \ --num-walks "$NUM_WALKS" \ --walk-length "$WALK_LENGTH" \ --window-size "$WINDOW_SIZE" \ --workers "$WORKERS" \ --negative "$NEGATIVE" \ --sample "$SAMPLE" \ --alpha "$ALPHA" \ --min-alpha "$MIN_ALPHA" \ --batch-words "$BATCH_WORDS" \ --formats Modern Legacy Standard \ --max-placement 32 \ --temporal-decay-days 365 \ --checkpoint-interval "$CHECKPOINT_INTERVAL" \ --progress-dir "$PROGRESS_DIR" \ "$@" echo "" echo " Training completed!" echo " Output: $OUTPUT" echo " Progress: $PROGRESS_DIR"