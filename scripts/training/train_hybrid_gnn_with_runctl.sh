#!/bin/bash # Train GNN embeddings using runctl (local or AWS) # Usage: ./scripts/training/train_hybrid_gnn_with_runctl.sh [local|aws] [instance-id] [options...] set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)" RUNCTL_BIN="${RUNCTL_BIN:-$PROJECT_ROOT/../runctl/target/release/runctl}" MODE="${1:-local}" shift || true # Default arguments (per cursor rules) EDGELIST="${EDGELIST:-data/graphs/edgelist.edg}" OUTPUT="${OUTPUT:-data/embeddings/gnn_graphsage.json}" MODEL_TYPE="${MODEL_TYPE:-GraphSAGE}" HIDDEN_DIM="${HIDDEN_DIM:-128}" NUM_LAYERS="${NUM_LAYERS:-2}" EPOCHS="${EPOCHS:-100}" LR="${LR:-0.01}" CHECKPOINT_INTERVAL="${CHECKPOINT_INTERVAL:-}" RESUME_FROM="${RESUME_FROM:-}" # Find or build runctl if [[ ! -f "$RUNCTL_BIN" ]]; then if [[ -d "$PROJECT_ROOT/../runctl" ]]; then echo "Warning: runctl not found, building..." (cd "$PROJECT_ROOT/../runctl" && cargo build --release) || { echo "Error: Failed to build runctl" exit 1 } else echo "Error: runctl not found at $RUNCTL_BIN" echo " Build it: cd ../runctl && cargo build --release" exit 1 fi fi echo " Training GNN embeddings with runctl (mode: $MODE)" echo " Edgelist: $EDGELIST" echo " Output: $OUTPUT" echo " Model: $MODEL_TYPE" echo " Epochs: $EPOCHS" if [[ -n "$CHECKPOINT_INTERVAL" ]]; then echo " Checkpoint Interval: $CHECKPOINT_INTERVAL" fi if [[ -n "$RESUME_FROM" ]]; then echo " Resume From: $RESUME_FROM" fi echo "" if [[ "$MODE" == "local" ]]; then # Local training "$RUNCTL_BIN" local "src/ml/scripts/train_gnn_with_runctl.py" -- \ --edgelist "$EDGELIST" \ --output "$OUTPUT" \ --model-type "$MODEL_TYPE" \ --hidden-dim "$HIDDEN_DIM" \ --num-layers "$NUM_LAYERS" \ --epochs "$EPOCHS" \ --learning-rate "$LR" \ "$@" elif [[ "$MODE" == "aws" ]]; then # AWS training if [[ $# -lt 1 ]]; then echo "Error: AWS mode requires instance ID" echo " Usage: $0 aws <instance-id> [options...]" exit 1 fi INSTANCE_ID="$1" shift || true # Use S3 paths for cloud training if [[ "$EDGELIST" != s3://* ]]; then EDGELIST_S3="s3://games-collections/graphs/edgelist.edg" echo "Warning: Local edgelist, will sync to: $EDGELIST_S3" else EDGELIST_S3="$EDGELIST" fi if [[ "$OUTPUT" != s3://* ]]; then OUTPUT_S3="s3://games-collections/embeddings/gnn_graphsage.json" echo "Warning: Local output, will sync to: $OUTPUT_S3" else OUTPUT_S3="$OUTPUT" fi # Per cursor rules: Use --data-s3 and --output-s3 for cloud training # Show all progress (no tail/head piping) COMMON_ARGS=( "--edgelist" "$EDGELIST_S3" "--output" "$OUTPUT_S3" "--model-type" "$MODEL_TYPE" "--hidden-dim" "$HIDDEN_DIM" "--num-layers" "$NUM_LAYERS" "--epochs" "$EPOCHS" "--learning-rate" "$LR" ) if [[ -n "$CHECKPOINT_INTERVAL" ]]; then COMMON_ARGS+=("--checkpoint-interval" "$CHECKPOINT_INTERVAL") fi if [[ -n "$RESUME_FROM" ]]; then COMMON_ARGS+=("--resume-from" "$RESUME_FROM") fi "$RUNCTL_BIN" aws train "$INSTANCE_ID" \ "src/ml/scripts/train_gnn_with_runctl.py" \ --data-s3 "$EDGELIST_S3" \ --output-s3 "$OUTPUT_S3" \ -- \ "${COMMON_ARGS[@]}" \ "$@" else echo "Error: Unknown mode: $MODE (use 'local' or 'aws')" exit 1 fi echo " Training complete"