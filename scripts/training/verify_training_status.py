#!/usr/bin/env python3 """ Verify which AWS instances are actually running training jobs. Checks: - SSM connectivity - Running processes - Recent command activity - S3 output activity - runctl session tracking NOTE: Excludes personal infrastructure instances (gyarados, alakazam). """ # /// script # requires-python = ">=3.11" # dependencies = [ # "boto3>=1.34.0", # ] # /// import json import subprocess import sys from datetime import datetime, timezone from pathlib import Path try: import boto3 except ImportError: print("Error: boto3 not available. Install with: uv pip install boto3") sys.exit(1) # Personal infrastructure instances (exclude from analysis) PERSONAL_INSTANCES = { "i-0bbef6e651c9588b1", # gyarados "i-0bb5da468ad8e730f", # alakazam } def get_running_instances(): """Get all running EC2 instances, excluding personal infrastructure.""" ec2 = boto3.client("ec2") response = ec2.describe_instances( Filters=[{"Name": "instance-state-name", "Values": ["running"]}] ) instances = [] for reservation in response["Reservations"]: for instance in reservation["Instances"]: instance_id = instance["InstanceId"] # Skip personal infrastructure if instance_id in PERSONAL_INSTANCES: continue name = None for tag in instance.get("Tags", []): if tag["Key"] == "Name": name = tag["Value"] break instances.append({ "id": instance_id, "type": instance["InstanceType"], "launch_time": instance["LaunchTime"], "name": name, "public_ip": instance.get("PublicIpAddress"), "private_ip": instance.get("PrivateIpAddress"), }) return instances def check_ssm_status(instance_id: str) -> dict: """Check SSM connectivity for an instance.""" ssm = boto3.client("ssm") try: response = ssm.describe_instance_information( Filters=[{"Key": "InstanceIds", "Values": [instance_id]}] ) if response["InstanceInformationList"]: info = response["InstanceInformationList"][0] return { "online": True, "ping_status": info.get("PingStatus"), "last_ping": info.get("LastPingDateTime"), "platform": info.get("PlatformType"), } else: return {"online": False, "reason": "Not in SSM"} except Exception as e: return {"online": False, "reason": str(e)} def check_running_processes(instance_id: str) -> dict: """Check for training-related processes on instance.""" ssm = boto3.client("ssm") # Check for Python processes cmd = "ps aux | grep -E '(python|train|embedding|pecan|node2vec)' | grep -v grep | head -10" try: response = ssm.send_command( InstanceIds=[instance_id], DocumentName="AWS-RunShellScript", Parameters={"commands": [cmd]}, ) command_id = response["Command"]["CommandId"] # Wait a moment for command to execute import time time.sleep(2) result = ssm.get_command_invocation( CommandId=command_id, InstanceId=instance_id, ) if result["Status"] == "Success": output = result.get("StandardOutputContent", "") processes = [line.strip() for line in output.split("\n") if line.strip()] return { "accessible": True, "processes": processes, "count": len(processes), } else: return { "accessible": True, "error": result.get("StandardErrorContent", ""), "status": result["Status"], } except Exception as e: return {"accessible": False, "error": str(e)} def check_recent_commands(instance_id: str, limit: int = 5) -> list: """Check recent SSM commands on instance.""" ssm = boto3.client("ssm") try: response = ssm.list_commands( InstanceId=instance_id, MaxResults=limit, ) commands = [] for cmd in response.get("Commands", []): commands.append({ "id": cmd["CommandId"], "status": cmd["Status"], "requested": cmd["RequestedDateTime"], "document": cmd["DocumentName"], }) return commands except Exception as e: return [] def check_s3_activity(instance_id: str, hours: int = 24) -> dict: """Check for recent S3 uploads that might indicate training activity.""" s3 = boto3.client("s3") bucket = "games-collections" try: # Check embeddings directory for recent uploads response = s3.list_objects_v2( Bucket=bucket, Prefix="embeddings/", ) recent_uploads = [] cutoff = datetime.now(timezone.utc).timestamp() - (hours * 3600) for obj in response.get("Contents", []): if obj["LastModified"].timestamp() > cutoff: recent_uploads.append({ "key": obj["Key"], "size": obj["Size"], "modified": obj["LastModified"], }) return { "recent_uploads": len(recent_uploads), "latest": recent_uploads[0] if recent_uploads else None, } except Exception as e: return {"error": str(e)} def check_runctl_sessions() -> dict: """Check runctl session files.""" sessions_dir = Path(".runctl/sessions") if not sessions_dir.exists(): return {"exists": False} sessions = [] now = datetime.now(timezone.utc) for session_file in sessions_dir.glob("*.json"): try: with open(session_file) as f: session = json.load(f) started_at = datetime.fromisoformat( session.get("started_at", "").replace("Z", "+00:00") ) age_hours = (now - started_at).total_seconds() / 3600 sessions.append({ "id": session.get("id"), "platform": session.get("platform"), "script": session.get("script"), "status": session.get("status"), "age_hours": round(age_hours, 1), "is_stale": age_hours > 24 and session.get("status") == "Running", }) except Exception: pass return { "exists": True, "count": len(sessions), "sessions": sessions, "stale_count": sum(1 for s in sessions if s.get("is_stale")), } def main(): """Main verification function.""" print("=" * 70) print("TRAINING STATUS VERIFICATION") print("(Excluding personal infrastructure: gyarados, alakazam)") print("=" * 70) print() # Get running instances print(" Checking AWS instances (training-related only)...") instances = get_running_instances() print(f" Found {len(instances)} training-related instances") print() if not instances: print(" No training-related instances running") print() return # Check each instance results = [] for instance in instances: instance_id = instance["id"] print(f"ðŸ” Instance: {instance_id}") print(f" Type: {instance['type']}") print(f" Name: {instance['name'] or '(none)'}") print(f" Launched: {instance['launch_time']}") print() # SSM status print(" Checking SSM connectivity...") ssm_status = check_ssm_status(instance_id) if ssm_status.get("online"): print(f" SSM Online ({ssm_status.get('ping_status')})") else: print(f" Error: SSM Offline: {ssm_status.get('reason')}") print() # Running processes (only if SSM is online) processes = {"count": 0, "accessible": False} if ssm_status.get("online"): print(" Checking running processes...") processes = check_running_processes(instance_id) if processes.get("accessible"): if processes.get("processes"): print(f" Found {processes['count']} training-related processes") for proc in processes["processes"][:3]: print(f" - {proc[:80]}") else: print(" Warning: No training processes found") else: print(f" Error: Cannot check processes: {processes.get('error', 'unknown error')}") else: print(" â­ï¸ Skipping process check (SSM offline)") print() # Recent commands print(" Checking recent SSM commands...") commands = check_recent_commands(instance_id) if commands: print(f" Found {len(commands)} recent commands:") for cmd in commands[:3]: status_icon = "" if cmd["status"] == "Success" else "â³" if cmd["status"] == "InProgress" else "Error:" print(f" {status_icon} {cmd['status']}: {cmd['requested']}") else: print(" No recent commands found") print() # Summary is_active = ( ssm_status.get("online") and processes.get("count", 0) > 0 ) results.append({ "instance": instance, "ssm_online": ssm_status.get("online"), "has_processes": processes.get("count", 0) > 0, "recent_commands": len(commands), "is_active": is_active, }) print("-" * 70) print() # Check S3 activity print("ðŸ“¦ Checking S3 activity...") s3_activity = check_s3_activity("dummy", hours=24) if s3_activity.get("recent_uploads"): print(f" {s3_activity['recent_uploads']} recent uploads in last 24h") if s3_activity.get("latest"): latest = s3_activity["latest"] print(f" Latest: {latest['key']} ({latest['size']} bytes)") else: print(" Warning: No recent S3 uploads") print() # Check runctl sessions print("ðŸ“‹ Checking runctl sessions...") sessions = check_runctl_sessions() if sessions.get("exists"): print(f" Found {sessions['count']} sessions") if sessions.get("stale_count"): print(f" Warning: {sessions['stale_count']} stale sessions (>24h old)") else: print(" No .runctl/sessions directory found") print() # Summary print("=" * 70) print("SUMMARY") print("=" * 70) print() active_count = sum(1 for r in results if r["is_active"]) print(f"Active Training Instances: {active_count}/{len(results)}") print() for result in results: instance = result["instance"] status = "ðŸŸ¢ ACTIVE" if result["is_active"] else "âšª IDLE" print(f" {status} {instance['id']} ({instance['type']})") if instance["name"]: print(f" Name: {instance['name']}") print(f" SSM: {'' if result['ssm_online'] else 'Error:'}") print(f" Processes: {result['has_processes']}") print(f" Recent commands: {result['recent_commands']}") print() print("=" * 70) if __name__ == "__main__": main()