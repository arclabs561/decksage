#!/usr/bin/env bash # Fine-tune instruction embeddings using runctl on AWS set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)" RUNCTL="${PROJECT_ROOT}/../runctl/target/release/runctl" # Check runctl exists if [ ! -f "$RUNCTL" ]; then echo "Error: runctl not found at $RUNCTL" echo "Build it with: cd ../runctl && cargo build --release" exit 1 fi # Configuration OUTPUT_VERSION="${OUTPUT_VERSION:-v2024-W01}" BASE_MODEL="${BASE_MODEL:-intfloat/e5-base-v2}" EPOCHS="${EPOCHS:-3}" BATCH_SIZE="${BATCH_SIZE:-16}" # S3 paths DATA_S3="${DATA_S3:-s3://games-collections/}" OUTPUT_S3="${OUTPUT_S3:-s3://games-collections/experiments/}" # Test set path (on S3 or local) TEST_SET="${TEST_SET:-s3://games-collections/experiments/test_set_unified_magic.json}" GRAPH_PATH="${GRAPH_PATH:-s3://games-collections/graphs/incremental_graph.db}" # Output path OUTPUT_DIR="data/embeddings/instruction_finetuned_${BASE_MODEL##*/}_${OUTPUT_VERSION}" OUTPUT_S3_PATH="${OUTPUT_S3}embeddings/instruction_finetuned_${BASE_MODEL##*/}_${OUTPUT_VERSION}/" echo "==========================================" echo "Fine-Tuning Instruction Embeddings" echo "==========================================" echo "Base model: $BASE_MODEL" echo "Output version: $OUTPUT_VERSION" echo "Epochs: $EPOCHS" echo "Batch size: $BATCH_SIZE" echo "Output: $OUTPUT_DIR" echo "Output S3: $OUTPUT_S3_PATH" echo "" # Create instance first, then train # Use SSH instead of SSM to avoid S3 bucket requirement # Try spot first, fallback to on-demand if spot fails echo "Creating AWS instance..." CREATE_OUTPUT=$("$RUNCTL" aws create \ --spot \ --key-name tarek \ g5.xlarge 2>&1) || CREATE_OUTPUT=$("$RUNCTL" aws create \ --key-name tarek \ g5.xlarge 2>&1) echo "$CREATE_OUTPUT" # Extract instance ID (look for "Created" or "instance:" pattern) INSTANCE_ID=$(echo "$CREATE_OUTPUT" | grep -iE '(created|instance:).*i-[a-z0-9]+' | grep -oE 'i-[a-z0-9]+' | head -1 || echo "") # Fallback: just get any i-* pattern if [ -z "$INSTANCE_ID" ]; then INSTANCE_ID=$(echo "$CREATE_OUTPUT" | grep -oE 'i-[a-z0-9]{17}' | head -1 || echo "") fi if [ -z "$INSTANCE_ID" ]; then echo "Error: Failed to create instance or extract instance ID" echo "Full output:" echo "$CREATE_OUTPUT" exit 1 fi echo " Created instance: $INSTANCE_ID" echo "Waiting for instance to be ready..." sleep 45 # Give instance time to initialize # Train on the instance # Note: S3 paths in --data-s3 and --output-s3 are base paths # Script arguments use relative paths or full S3 paths echo "Submitting fine-tuning job..." "$RUNCTL" aws train "$INSTANCE_ID" \ "src/ml/scripts/train_instruction_finetune.py" \ --data-s3 "$DATA_S3" \ --output-s3 "$OUTPUT_S3" \ -- \ --base-model "$BASE_MODEL" \ --output "$OUTPUT_DIR" \ --test-set "$TEST_SET" \ --graph "$GRAPH_PATH" \ --task-type substitution \ --epochs "$EPOCHS" \ --batch-size "$BATCH_SIZE" \ --learning-rate 2e-5 \ --warmup-steps 100 echo "" echo "Training started on instance: $INSTANCE_ID" echo "The instance will auto-stop when training completes (via runctl's auto-stop feature)" echo "" echo " Fine-tuning job submitted!" echo "Instance: $INSTANCE_ID" echo "Monitor with: $RUNCTL aws monitor $INSTANCE_ID"
