#!/bin/bash # Train enhanced embeddings using runctl on AWS/RunPod set -e SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)" cd "$PROJECT_ROOT" # Find or build runctl RUNCTL_BIN="" if [ -f "../runctl/target/release/runctl" ]; then RUNCTL_BIN="../runctl/target/release/runctl" elif [ -f "runctl" ]; then RUNCTL_BIN="./runctl" elif command -v runctl &> /dev/null; then RUNCTL_BIN="runctl" else echo "Building runctl..." if [ -d "../runctl" ]; then cd ../runctl cargo build --release cd "$PROJECT_ROOT" RUNCTL_BIN="../runctl/target/release/runctl" else echo "Error: runctl not found and cannot build" exit 1 fi fi echo "======================================================================" echo "TRAINING ENHANCED EMBEDDINGS WITH RUNCTL" echo "======================================================================" echo "Using runctl: $RUNCTL_BIN" echo "" # Check if we should use AWS or RunPod PLATFORM="${1:-aws}" if [ "$PLATFORM" = "aws" ]; then INSTANCE_ID="${2:-}" INSTANCE_TYPE="${3:-}" # Optional: instance type for auto-configuration if [ -z "$INSTANCE_ID" ]; then echo "Error: Instance ID required for AWS mode" echo "Usage: $0 aws <instance-id> [instance-type]" echo "Create instance: $RUNCTL_BIN aws create --spot g5.xlarge" echo "" echo "Recommended instance types:" echo " - g5.xlarge (4 vCPU, 16GB RAM, GPU) - Good balance" echo " - g5.2xlarge (8 vCPU, 32GB RAM, GPU) - Faster" echo " - g5.4xlarge (16 vCPU, 64GB RAM, GPU) - Very fast" echo " - g4dn.xlarge (4 vCPU, 16GB RAM, GPU) - Cost-effective" echo " - m5.2xlarge (8 vCPU, 32GB RAM) - CPU-only, cheaper" exit 1 fi echo "Platform: AWS" echo "Instance: $INSTANCE_ID" # Auto-detect instance type if not provided if [ -z "$INSTANCE_TYPE" ]; then INSTANCE_TYPE=$(aws ec2 describe-instances --instance-ids "$INSTANCE_ID" \ --query 'Reservations[0].Instances[0].InstanceType' --output text 2>/dev/null || echo "unknown") echo "Detected instance type: $INSTANCE_TYPE" else echo "Instance type: $INSTANCE_TYPE" fi # Auto-configure workers based on instance type # Extract vCPU count from instance type (e.g., g5.2xlarge = 8 vCPU) if echo "$INSTANCE_TYPE" | grep -qE '\.(xlarge|2xlarge|4xlarge|8xlarge|12xlarge|16xlarge|24xlarge)'; then case "$INSTANCE_TYPE" in *.xlarge) WORKERS=4 ;; *.2xlarge) WORKERS=8 ;; *.4xlarge) WORKERS=16 ;; *.8xlarge) WORKERS=32 ;; *.12xlarge) WORKERS=48 ;; *.16xlarge) WORKERS=64 ;; *.24xlarge) WORKERS=96 ;; *) WORKERS=8 ;; # Default esac # Cap workers for Word2Vec efficiency (diminishing returns after 16) if [ "$WORKERS" -gt 16 ]; then WORKERS=16 fi else WORKERS=8 # Default for unknown types fi echo "Auto-configured workers: $WORKERS" echo "" echo "Submitting training job to AWS..." # Use runctl aws train with instance ID # Use S3 paths for cloud training (faster, avoids sync) # Prefer SQLite graph (.db) over JSON for faster loading # Workers auto-configured based on instance size $RUNCTL_BIN aws train "$INSTANCE_ID" \ "src/ml/scripts/train_multitask_refined_enhanced.py" \ --data-s3 s3://games-collections/ \ --output-s3 s3://games-collections/embeddings/multitask/ \ -- \ --graph-db s3://games-collections/graphs/incremental_graph.db \ --decks s3://games-collections/processed/decks_all_final.jsonl \ --output data/embeddings/multitask/multitask_enhanced.wv \ --dim 128 \ --epochs 20 \ --formats Modern Legacy Standard \ --max-placement 32 \ --temporal-decay-days 365 \ --workers "$WORKERS" \ --checkpoint-interval 5 \ --progress-dir data/embeddings/multitask/training_progress \ --output-version v2024-W$(date +%V) echo "" echo " Training job submitted to AWS" echo "Monitor progress with: $RUNCTL_BIN aws monitor $INSTANCE_ID" elif [ "$PLATFORM" = "runpod" ]; then INSTANCE_ID="${2:-}" if [ -z "$INSTANCE_ID" ]; then echo "Error: Instance ID required for RunPod mode" echo "Usage: $0 runpod <instance-id>" exit 1 fi echo "Platform: RunPod" echo "Instance: $INSTANCE_ID" echo "" echo "Submitting training job to RunPod..." $RUNCTL_BIN runpod train "$INSTANCE_ID" \ "src/ml/scripts/train_multitask_refined_enhanced.py" \ --output-s3 s3://games-collections/embeddings/multitask/ \ -- \ --pairs data/processed/pairs_with_functional.csv \ --decks data/processed/decks_all_final.jsonl \ --output data/embeddings/multitask/multitask_enhanced.wv \ --dim 128 \ --epochs 5 \ --formats Modern Legacy Standard \ --max-placement 32 \ --temporal-decay-days 365 \ --workers 4 echo "" echo " Training job submitted to RunPod" else echo "Error: Unknown platform '$PLATFORM'. Use 'aws' or 'runpod'" exit 1 fiset -euo pipefail
