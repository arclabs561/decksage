#!/usr/bin/env bash # Train full hybrid system (co-occurrence + GNN + instruction) via runctl on AWS set -euo pipefail SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)" RUNCTL="${PROJECT_ROOT}/../runctl/target/release/runctl" # Check runctl exists if [ ! -f "$RUNCTL" ]; then echo "Error: runctl not found at $RUNCTL" echo "Build it with: cd ../runctl && cargo build --release" exit 1 fi # Configuration OUTPUT_VERSION="${OUTPUT_VERSION:-v2024-W01}" SKIP_GNN="${SKIP_GNN:-false}" # S3 paths DATA_S3="${DATA_S3:-s3://games-collections/}" OUTPUT_S3="${OUTPUT_S3:-s3://games-collections/experiments/}" # Data paths DECKS_JSONL="${DECKS_JSONL:-s3://games-collections/processed/decks_all_final.jsonl}" GRAPH_PATH="${GRAPH_PATH:-s3://games-collections/graphs/incremental_graph.db}" # Output paths (train_hybrid_full.py doesn't have separate co-occurrence output, it trains GNN only) GNN_OUTPUT="data/embeddings/gnn_graphsage_${OUTPUT_VERSION}.json" echo "==========================================" echo "Training Full Hybrid System" echo "==========================================" echo "Decks: $DECKS_JSONL" echo "Graph: $GRAPH_PATH" echo "Output version: $OUTPUT_VERSION" echo "Skip GNN: $SKIP_GNN" echo "GNN output: $GNN_OUTPUT" echo "" # Create instance first, then train # Use SSH instead of SSM to avoid S3 bucket requirement # Try spot first, fallback to on-demand if spot fails echo "Creating AWS instance with EBS volume..." CREATE_OUTPUT=$("$RUNCTL" aws create \ --spot \ --key-name tarek \ --data-volume-size 500 \ g5.2xlarge 2>&1) || CREATE_OUTPUT=$("$RUNCTL" aws create \ --key-name tarek \ --data-volume-size 500 \ g5.2xlarge 2>&1) echo "$CREATE_OUTPUT" # Extract instance ID (look for "Created" or "instance:" pattern) INSTANCE_ID=$(echo "$CREATE_OUTPUT" | grep -iE '(created|instance:).*i-[a-z0-9]+' | grep -oE 'i-[a-z0-9]+' | head -1 || echo "") # Fallback: just get any i-* pattern (17 chars after i-) if [ -z "$INSTANCE_ID" ]; then INSTANCE_ID=$(echo "$CREATE_OUTPUT" | grep -oE 'i-[a-z0-9]{17}' | head -1 || echo "") fi if [ -z "$INSTANCE_ID" ]; then echo "Error: Failed to create instance or extract instance ID" echo "Full output:" echo "$CREATE_OUTPUT" exit 1 fi echo " Created instance: $INSTANCE_ID" echo "Waiting for instance to be ready..." sleep 45 # Give instance time to initialize # Build training command TRAIN_CMD=( "$RUNCTL" aws train "$INSTANCE_ID" "src/ml/scripts/train_hybrid_full.py" --data-s3 "$DATA_S3" --output-s3 "$OUTPUT_S3" -- --decks-path "$DECKS_JSONL" --graph-path "$GRAPH_PATH" --gnn-output "$GNN_OUTPUT" --use-temporal-split ) if [ "$SKIP_GNN" = "true" ]; then TRAIN_CMD+=(--skip-gnn) fi # Train on the instance echo "Submitting full hybrid training job..." "${TRAIN_CMD[@]}" echo "" echo " Full hybrid training job submitted!" echo "Instance: $INSTANCE_ID" echo "Training: Co-occurrence + GNN + Instruction embeddings" echo "Monitor with: $RUNCTL aws monitor $INSTANCE_ID" echo "Or check status: $RUNCTL aws status $INSTANCE_ID"