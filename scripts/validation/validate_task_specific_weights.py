#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [ # "pandas>=2.0.0", # "numpy<2.0.0", # ] # /// """ Validate task-specific weight improvements. Tests whether task-specific fusion weights improve performance compared to default weights for each downstream task. """ from __future__ import annotations import argparse import json import logging from pathlib import Path from typing import Any import sys _script_file = Path(__file__).resolve() _src_dir = _script_file.parent.parent / "src" if str(_src_dir) not in sys.path: sys.path.insert(0, str(_src_dir)) from ml.similarity.fusion import WeightedLateFusion, FusionWeights from ml.utils.fusion_improvements import create_task_specific_weights from ml.utils.paths import PATHS logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s') logger = logging.getLogger(__name__) def test_task_weights( task_type: str, base_weights: FusionWeights | None = None, ) -> dict[str, Any]: """ Test task-specific weights vs default weights. Returns: Dictionary with weight comparison """ if base_weights is None: base_weights = FusionWeights() task_weights = create_task_specific_weights(task_type, base_weights) return { "task_type": task_type, "base_weights": { "embed": base_weights.embed, "jaccard": base_weights.jaccard, "functional": base_weights.functional, "text_embed": base_weights.text_embed, "gnn": base_weights.gnn, }, "task_weights": { "embed": task_weights.embed, "jaccard": task_weights.jaccard, "functional": task_weights.functional, "text_embed": task_weights.text_embed, "gnn": task_weights.gnn, }, "changes": { "embed": task_weights.embed - base_weights.embed, "jaccard": task_weights.jaccard - base_weights.jaccard, "functional": task_weights.functional - base_weights.functional, "text_embed": task_weights.text_embed - base_weights.text_embed, "gnn": task_weights.gnn - base_weights.gnn, }, } def main() -> int: """Validate task-specific weights.""" parser = argparse.ArgumentParser(description="Validate task-specific fusion weights") parser.add_argument("--output", type=Path, help="Output JSON file") args = parser.parse_args() tasks = ["substitution", "similarity", "discovery", "completion"] results = {} logger.info("Testing task-specific weights...") base_weights = FusionWeights() logger.info(f"Base weights: embed={base_weights.embed:.3f}, jaccard={base_weights.jaccard:.3f}, " f"functional={base_weights.functional:.3f}, text_embed={base_weights.text_embed:.3f}, " f"gnn={base_weights.gnn:.3f}") for task in tasks: logger.info(f"\nTask: {task}") task_result = test_task_weights(task, base_weights) results[task] = task_result changes = task_result["changes"] logger.info(f" Weight changes:") logger.info(f" embed: {changes['embed']:+.3f}") logger.info(f" jaccard: {changes['jaccard']:+.3f}") logger.info(f" functional: {changes['functional']:+.3f}") logger.info(f" text_embed: {changes['text_embed']:+.3f}") logger.info(f" gnn: {changes['gnn']:+.3f}") # Save results if args.output: args.output.parent.mkdir(parents=True, exist_ok=True) with open(args.output, 'w') as f: json.dump(results, f, indent=2) logger.info(f"\n Results saved to {args.output}") logger.info("\n Task-specific weight validation complete") return 0 if __name__ == "__main__": exit(main())