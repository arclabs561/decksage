#!/bin/bash # Comprehensive S3 sync for DeckSage data # Syncs all critical data to S3 with proper organization set -euo pipefail BUCKET="s3://games-collections" SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)" cd "$PROJECT_ROOT" echo "=" | tr '=' '=' echo "S3 DATA SYNC - COMPREHENSIVE" echo "=" | tr '=' '=' echo # Prefer s5cmd (10-100x faster), fallback to aws cli if command -v s5cmd &> /dev/null; then USE_S5CMD=true SYNC_CMD="s5cmd sync" LS_CMD="s5cmd ls" echo " Using s5cmd (fast S3 operations)" elif command -v aws &> /dev/null; then USE_S5CMD=false SYNC_CMD="aws s3 sync" LS_CMD="aws s3 ls" echo "Warning: Using aws cli (slower). Install s5cmd for 10-100x speedup: https://github.com/peak/s5cmd" else echo "Error: Neither s5cmd nor aws cli found. Install one of them." exit 1 fi # Check bucket access if [[ "$USE_S5CMD" == "true" ]]; then if ! s5cmd ls "$BUCKET" &> /dev/null; then echo "Error: Cannot access bucket: $BUCKET" echo " Check AWS credentials: aws sts get-caller-identity" exit 1 fi else if ! aws s3 ls "$BUCKET" &> /dev/null; then echo "Error: Cannot access bucket: $BUCKET" echo " Check AWS credentials: aws sts get-caller-identity" exit 1 fi fi echo " Bucket accessible: $BUCKET" echo # Sync processed data echo " Syncing processed data..." if [ -d "data/processed" ]; then if [[ "$USE_S5CMD" == "true" ]]; then s5cmd sync data/processed/ "$BUCKET/processed/" \ --exclude "*.tmp" \ --exclude "*.log" \ --exclude "__pycache__/*" \ --exclude "*.pyc" \ --delete else aws s3 sync data/processed/ "$BUCKET/processed/" \ --exclude "*.tmp" \ --exclude "*.log" \ --exclude "__pycache__/*" \ --exclude "*.pyc" \ --delete fi echo " Processed data synced (includes decks_all_final.jsonl)" else echo " Warning: data/processed/ not found" fi # Sync embeddings echo " Syncing embeddings..." if [ -d "data/embeddings" ]; then if [[ "$USE_S5CMD" == "true" ]]; then s5cmd sync data/embeddings/ "$BUCKET/embeddings/" \ --exclude "*.tmp" \ --exclude "*.log" \ --delete else aws s3 sync data/embeddings/ "$BUCKET/embeddings/" \ --exclude "*.tmp" \ --exclude "*.log" \ --delete fi echo " Embeddings synced" else echo " Warning: data/embeddings/ not found" fi # Sync experiments echo " Syncing experiments..." if [ -d "experiments" ]; then if [[ "$USE_S5CMD" == "true" ]]; then s5cmd sync experiments/ "$BUCKET/experiments/" \ --exclude "*.tmp" \ --exclude "*.log" \ --exclude "__pycache__/*" \ --exclude "checkpoint_*.json" \ --delete else aws s3 sync experiments/ "$BUCKET/experiments/" \ --exclude "*.tmp" \ --exclude "*.log" \ --exclude "__pycache__/*" \ --exclude "checkpoint_*.json" \ --delete fi echo " Experiments synced" else echo " Warning: experiments/ not found" fi # Sync graphs echo " Syncing graphs..." if [ -d "data/graphs" ]; then if [[ "$USE_S5CMD" == "true" ]]; then s5cmd sync data/graphs/ "$BUCKET/graphs/" \ --exclude "*.tmp" \ --exclude "*.log" \ --exclude "*.db-shm" \ --exclude "*.db-wal" \ --delete else aws s3 sync data/graphs/ "$BUCKET/graphs/" \ --exclude "*.tmp" \ --exclude "*.log" \ --exclude "*.db-shm" \ --exclude "*.db-wal" \ --delete fi echo " Graphs synced" else echo " Warning: data/graphs/ not found" fi echo echo "=" | tr '=' '=' echo "SYNC COMPLETE" echo "=" | tr '=' '=' echo # Show bucket summary echo " Bucket Summary:" if [[ "$USE_S5CMD" == "true" ]]; then s5cmd du "$BUCKET/" 2>&1 | tail -3 else aws s3 ls "$BUCKET/" --recursive --human-readable --summarize 2>&1 | tail -5 fi
