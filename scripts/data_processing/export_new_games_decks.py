#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [] # /// """ Export decks for new games (Digimon, One Piece, Riftbound, Yu-Gi-Oh!). This script exports decks from S3 or local data directories to processed/ format. Addresses Priority 1 from DATA_COVERAGE_CRITIQUE.md. """ import argparse import json import subprocess import sys from pathlib import Path from typing import Any # Add src to path script_dir = Path(__file__).parent src_dir = script_dir.parent.parent / "src" if str(src_dir) not in sys.path: sys.path.insert(0, str(src_dir)) from ml.utils.paths import PATHS def export_decks_from_s3_or_local( game: str, dataset_name: str, s3_prefix: str, local_path: Path | None = None, output_file: Path | None = None, ) -> int: """Export decks from S3 or local data using Go export-hetero tool.""" if output_file is None: output_file = PATHS.processed / f"decks_{game}_{dataset_name}.jsonl" if output_file.exists(): count = sum(1 for _ in open(output_file)) print(f"Warning: {output_file} exists with {count:,} decks, skipping...") return count # Try local first, then S3 data_path = None if local_path and local_path.exists(): data_path = local_path print(f"ðŸ“ Using local data: {local_path}") else: # Check S3 print(f"â˜ï¸ Checking S3: s3://games-collections/{s3_prefix}") # For now, we'll need to download from S3 or use the Go tool with S3 bucket # The export-hetero tool should support S3 buckets data_path = f"s3://games-collections/{s3_prefix}" # Build export-hetero if needed export_binary = Path("bin/export-hetero") if not export_binary.exists(): print("Building export-hetero...") go_tool = Path("src/backend/cmd/export-hetero/main.go") if not go_tool.exists(): print(f"Error: Export tool not found: {go_tool}") return 0 result = subprocess.run( ["go", "build", "-o", str(export_binary), str(go_tool)], cwd=src_dir.parent / "backend", capture_output=True, text=True, ) if result.returncode != 0: print(f"Error: Failed to build: {result.stderr}") return 0 # Run export output_file.parent.mkdir(parents=True, exist_ok=True) print(f"Exporting {game}/{dataset_name} from {data_path}...") result = subprocess.run( [str(export_binary), str(data_path), str(output_file)], capture_output=True, text=True, ) if result.returncode != 0: print(f"Error: Export failed: {result.stderr}") return 0 count = sum(1 for _ in open(output_file)) if output_file.exists() else 0 print(f" Exported {count:,} {game} decks to {output_file}") return count def main() -> int: parser = argparse.ArgumentParser(description="Export decks for new games") parser.add_argument("--game", choices=["digimon", "onepiece", "riftbound", "yugioh", "all"], default="all", help="Game to export") parser.add_argument("--output-dir", type=Path, default=PATHS.processed, help="Output directory for exported decks") parser.add_argument("--local-data", type=Path, help="Local data directory (data-full/games or similar)") parser.add_argument("--use-s3", action="store_true", help="Use S3 bucket instead of local data") args = parser.parse_args() # Define data sources for each game game_sources = { "yugioh": [ ("ygoprodeck-tournament", "games/yugioh/ygoprodeck-tournament", Path("data-full/games/yugioh/ygoprodeck-tournament") if args.local_data else None), ], "digimon": [ ("limitless-web", "games/digimon/digimon-limitless-web", Path("data-full/games/digimon/digimon-limitless-web") if args.local_data else None), ], "onepiece": [ ("limitless-web", "games/onepiece/onepiece-limitless-web", Path("data-full/games/onepiece/onepiece-limitless-web") if args.local_data else None), ], "riftbound": [ ("riftcodex", "games/riftbound/riftcodex", Path("data-full/games/riftbound/riftcodex") if args.local_data else None), ("riftboundgg", "games/riftbound/riftboundgg", Path("data-full/games/riftbound/riftboundgg") if args.local_data else None), ("riftmana", "games/riftbound/riftmana", Path("data-full/games/riftbound/riftmana") if args.local_data else None), ], } games_to_export = [args.game] if args.game != "all" else list(game_sources.keys()) print("=" * 80) print("EXPORTING DECKS FOR NEW GAMES") print("=" * 80) print() total_exported = 0 for game in games_to_export: if game not in game_sources: print(f"Warning: Unknown game: {game}") continue print(f"\n {game.upper()}:") print("-" * 80) for dataset_name, s3_prefix, local_path in game_sources[game]: output_file = args.output_dir / f"decks_{game}_{dataset_name}.jsonl" count = export_decks_from_s3_or_local( game, dataset_name, s3_prefix, local_path, output_file ) total_exported += count print("\n" + "=" * 80) print(f" Total decks exported: {total_exported:,}") print("=" * 80) return 0 if __name__ == "__main__": sys.exit(main())
