#!/usr/bin/env python3 # /// script # requires-python = ">=3.11" # dependencies = [] # /// """ Backfill missing metadata from URLs and patterns. Extracts: - Player names from URLs - Event names from URLs - Placement from URLs - Format from archetype patterns """ from __future__ import annotations import argparse import json import re import sys from pathlib import Path from typing import Any def extract_metadata_from_url(url: str) -> dict[str, Any]: """Extract metadata from URL patterns.""" metadata = {} if not url: return metadata url_lower = url.lower() # Extract player name (common patterns) # mtgtop8.com/deck/?d=123456&player=John+Doe player_match = re.search(r'[?&]player=([^&]+)', url_lower) if player_match: metadata["player"] = unquote(player_match.group(1)).replace("+", " ").title() # Extract event name # mtgtop8.com/event?e=12345&d=123456 event_match = re.search(r'[?&]e=(\d+)', url) if event_match: metadata["event_id"] = event_match.group(1) # Extract placement from URL or deck name placement_match = re.search(r'(?:top|place|rank|#)(\d+)', url_lower) if placement_match: try: metadata["placement"] = int(placement_match.group(1)) except ValueError: pass return metadata def infer_format_from_archetype(archetype: str, game: str) -> str | None: """Infer format from archetype patterns.""" if not archetype: return None archetype_lower = archetype.lower() if game == "magic": # Format indicators in archetype if any(x in archetype_lower for x in ["commander", "edh", "cedh"]): return "Commander" elif "pauper" in archetype_lower: return "Pauper" elif "modern" in archetype_lower: return "Modern" elif "legacy" in archetype_lower: return "Legacy" elif "vintage" in archetype_lower: return "Vintage" elif "pioneer" in archetype_lower: return "Pioneer" elif "standard" in archetype_lower: return "Standard" return None def backfill_metadata( input_file: Path, output_file: Path, ) -> dict[str, Any]: """Backfill missing metadata.""" stats = { "total": 0, "player_added": 0, "event_added": 0, "placement_added": 0, "format_added": 0, } enhanced_decks = [] print(f"Backfilling metadata from {input_file}...") with open(input_file) as f: for line_num, line in enumerate(f, 1): if not line.strip(): continue try: deck = json.loads(line) stats["total"] += 1 # Extract from URL url_metadata = extract_metadata_from_url(deck.get("url", "")) if not deck.get("player") and url_metadata.get("player"): deck["player"] = url_metadata["player"] stats["player_added"] += 1 if not deck.get("event") and url_metadata.get("event_id"): deck["event"] = f"Event {url_metadata['event_id']}" stats["event_added"] += 1 if not deck.get("placement") and url_metadata.get("placement"): deck["placement"] = url_metadata["placement"] stats["placement_added"] += 1 # Infer format from archetype if not deck.get("format") or deck.get("format") == "": game = deck.get("game", "") archetype = deck.get("archetype", "") inferred_format = infer_format_from_archetype(archetype, game) if inferred_format: deck["format"] = inferred_format stats["format_added"] += 1 enhanced_decks.append(deck) if line_num % 10000 == 0: print(f" Processed {line_num:,} decks...") except Exception as e: print(f" Warning: Error at line {line_num}: {e}") continue # Write enhanced decks print(f"\nWriting {len(enhanced_decks):,} decks with backfilled metadata...") output_file.parent.mkdir(parents=True, exist_ok=True) with open(output_file, "w") as f: for deck in enhanced_decks: json.dump(deck, f) f.write("\n") return stats def unquote(s: str) -> str: """Simple URL unquote.""" import urllib.parse return urllib.parse.unquote(s) def main() -> int: """Backfill missing metadata.""" parser = argparse.ArgumentParser(description="Backfill missing metadata") parser.add_argument("--input", type=Path, default=Path("data/processed/decks_all_enhanced.jsonl"), help="Input file") parser.add_argument("--output", type=Path, default=Path("data/processed/decks_all_final.jsonl"), help="Output file") args = parser.parse_args() if not args.input.exists(): print(f"Error: Input file not found: {args.input}") return 1 print("=" * 70) print("BACKFILLING METADATA") print("=" * 70) stats = backfill_metadata(args.input, args.output) print("\n" + "=" * 70) print("BACKFILL SUMMARY") print("=" * 70) print(f"Total decks: {stats['total']:,}") print(f"Player added: {stats['player_added']:,}") print(f"Event added: {stats['event_added']:,}") print(f"Placement added: {stats['placement_added']:,}") print(f"Format added: {stats['format_added']:,}") print(f"\n Enhanced decks saved to: {args.output}") return 0 if __name__ == "__main__": sys.exit(main())
