# Pre-commit hooks: Fast checks that run on every commit
# Pre-push hooks: Slower checks (tests, type checking) run before push
# See: https://pre-commit.com/hooks.html
#
# INSTALLATION:
#   Run: just pre-commit-install
#   Or:  ./scripts/setup-dev.sh
#   Or:  uv pip install pre-commit && pre-commit install && pre-commit install --hook-type pre-push
#
# Hooks run automatically on:
#   - git commit (all pre-commit hooks)
#   - git push (pre-push hooks: fast tests)
#
# Manual run:
#   - just pre-commit-run (all files)
#   - pre-commit run (staged files only)
#
# NOTE FOR AI AGENTS:
#   - Review docs/DEVELOPMENT_RULES.md for common rules and themes
#   - Check .cursor/rules/*.mdc for detailed project-specific rules
#   - All hooks are optimized to check only changed files (fast execution)
#   - Custom hooks review recent changes and enforce project patterns

repos:
  # Python: Ruff (linter + formatter)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.10
    hooks:
      - id: ruff
        args: [--fix]
        stages: [commit]
        types: [python]
        exclude: |
          (?x)^(
            .*_embeddings\.py|
            .*_trainctl\.py|
            .*/__pycache__/|
            .*\.pyc$|
            build/|
            dist/|
            \.venv/|
            venv/|
            archive/
            experiments/archived/
          )
      - id: ruff-format
        stages: [commit]
        types: [python]
        exclude: |
          (?x)^(
            .*_embeddings\.py|
            .*_trainctl\.py|
            .*/__pycache__/|
            build/|
            dist/|
            \.venv/|
            venv/
          )

  # Go: golangci-lint (comprehensive Go linter)
  # Updated to v2.6.2 for Go 1.24 support and v2 config format compatibility
  - repo: https://github.com/golangci/golangci-lint
    rev: v2.6.2
    hooks:
      - id: golangci-lint
        stages: [commit]
        args: [--timeout=5m]
        files: ^src/backend/.*\.go$

  # Shell: shellcheck (shell script linter)
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.10.0.1
    hooks:
      - id: shellcheck
        stages: [commit]
        types: [shell]
        args: [-e, SC1091]  # Allow sourcing files without checking
        exclude: |
          (?x)^(
            \.git/|
            \.venv/|
            venv/|
            node_modules/|
            build/|
            dist/
          )

  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        stages: [commit]
        exclude: |
          (?x)^(
            \.git/|
            \.venv/|
            venv/|
            node_modules/|
            build/|
            dist/|
            \.pyc$|
            \.lock$|
            \.zst$|
            \.sst$|
            \.wv$|
            \.kv$|
            \.edg$|
            data/raw/|
            data/embeddings/|
            data/graphs/|
            data/archive/
          )
      - id: end-of-file-fixer
        stages: [commit]
        exclude: |
          (?x)^(
            \.git/|
            \.venv/|
            venv/|
            node_modules/|
            build/|
            dist/|
            \.pyc$|
            \.lock$|
            \.zst$|
            \.sst$|
            \.wv$|
            \.kv$|
            \.edg$|
            data/raw/|
            data/embeddings/|
            data/graphs/|
            data/archive/
          )
      - id: check-yaml
        stages: [commit]
        exclude: |
          (?x)^(
            \.git/|
            \.venv/|
            venv/|
            node_modules/|
            build/|
            dist/|
            data/raw/|
            data/embeddings/|
            data/graphs/|
            data/archive/
          )
      - id: check-json
        stages: [commit]
        exclude: |
          (?x)^(
            \.git/|
            \.venv/|
            venv/|
            node_modules/|
            build/|
            dist/|
            data/raw/|
            data/embeddings/|
            data/graphs/|
            data/archive/|
            experiments/.*\.json$
          )
      - id: check-added-large-files
        args: ['--maxkb=1000']
        stages: [commit]
      - id: check-merge-conflict
        stages: [commit]
      - id: check-toml
        stages: [commit]
        exclude: |
          (?x)^(
            \.git/|
            \.venv/|
            venv/|
            node_modules/|
            build/|
            dist/
          )
      - id: mixed-line-ending
        stages: [commit]
        exclude: |
          (?x)^(
            \.git/|
            \.venv/|
            venv/|
            node_modules/|
            build/|
            dist/|
            \.pyc$|
            \.lock$|
            \.zst$|
            \.sst$|
            \.wv$|
            \.kv$|
            \.edg$
          )
      - id: check-executables-have-shebangs
        stages: [commit]
        types: [text]
        exclude: |
          (?x)^(
            \.git/|
            \.venv/|
            venv/|
            node_modules/|
            build/|
            dist/|
            \.md$|
            \.txt$|
            \.py$|  # Python files can be modules or scripts
            \.go$|
            justfile$|
            \.json$|
            \.yaml$|
            \.yml$|
            \.pre-commit-config\.yaml$  # Config file, not executable
          )
      - id: check-shebang-scripts-are-executable
        stages: [commit]
        types: [text]
        exclude: |
          (?x)^(
            \.git/|
            \.venv/|
            venv/|
            node_modules/|
            build/|
            dist/|
            \.md$|
            \.txt$|
            \.py$|  # Python files can be modules or scripts
            \.go$|
            justfile$|
            \.json$|
            \.yaml$|
            \.yml$|
            \.pre-commit-config\.yaml$  # Config file, not executable
          )

  # Data lineage validation (runs before commit)
  - repo: local
    hooks:
      - id: validate-lineage
        name: Validate data lineage
        entry: bash -c 'python3 scripts/data_processing/validate_lineage.py'
        language: system
        pass_filenames: false
        always_run: true
        stages: [commit]
        verbose: true

      # Review recently edited files for common rule violations
      # This helps both humans and AI agents catch issues early
      - id: review-recent-changes
        name: Review recent changes
        entry: bash -c 'python3 scripts/validation/review_recent_changes.py --staged || true'
        language: system
        pass_filenames: false
        always_run: true
        stages: [commit]
        verbose: true
        fail_fast: false  # Non-blocking, informational

      # Check for hardcoded paths (should use PATHS utility)
      # Non-blocking: warns but doesn't fail (many existing instances)
      # Only runs on changed files for speed
      - id: check-hardcoded-paths
        name: Check for hardcoded paths
        entry: bash -c 'python3 scripts/validation/check_hardcoded_paths.py "$@" || true'
        language: system
        types: [python]
        stages: [commit]
        pass_filenames: true  # Only check changed files
        exclude: |
          (?x)^(
            src/ml/utils/paths\.py|
            scripts/data_processing/validate_lineage\.py|
            scripts/validation/check_hardcoded_paths\.py|
            \.venv/|
            venv/|
            __pycache__/|
            archive/|
            tests/
          )

      # Check for TODO/FIXME in committed code (warn, don't fail)
      # Only runs on changed files for speed
      - id: check-todo
        name: Check for TODO/FIXME
        entry: bash -c 'for f in "$@"; do grep -Hn "TODO\|FIXME\|XXX\|HACK" "$f" 2>/dev/null | head -3; done || true'
        language: system
        types: [python]
        stages: [commit]
        pass_filenames: true  # Only check changed files
        verbose: false  # Reduce noise

      # Validate Python file permissions (shebang vs executable)
      # Only runs on changed files for speed
      - id: check-python-permissions
        name: Check Python file permissions
        entry: bash -c 'for f in "$@"; do if head -1 "$f" 2>/dev/null | grep -q "^#!/usr/bin/env python"; then test -x "$f" || echo "⚠️  $f has shebang but is not executable"; fi; done || true'
        language: system
        types: [python]
        stages: [commit]
        pass_filenames: true  # Only check changed files
        verbose: false  # Reduce noise

  # Pre-push: Fast tests (unit tests only, no slow/integration)
  # Only run if Python files changed (optimization)
  - repo: local
    hooks:
      - id: pytest-fast
        name: pytest (fast tests only)
        entry: bash -c 'cd src/ml && uv run pytest tests/ -v -m "not slow and not integration" --maxfail=1 || true'
        language: system
        pass_filenames: false
        always_run: false
        stages: [push]
        types: [python]  # Only run if Python files changed
        verbose: false  # Reduce noise

  # Manual: Full test suite (run with --hook-stage manual)
  - repo: local
    hooks:
      - id: pytest-full
        name: pytest (full suite)
        entry: bash -c 'cd src/ml && uv run pytest tests/ -v || true'
        language: system
        pass_filenames: false
        always_run: false
        stages: [manual]
